/*! For license information please see multiplayer.bundle.js.LICENSE.txt */
(()=>{"use strict";var e,t,n,r={699:(e,t,n)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function o(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",i=n.toStringTag||"@@toStringTag";function l(n,r,o,i){var l=r&&r.prototype instanceof u?r:u,s=Object.create(l.prototype);return a(s,"_invoke",function(n,r,o){var a,i,l,u=0,s=o||[],d=!1,m={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,n){return a=t,i=0,l=e,m.n=n,c}};function p(n,r){for(i=n,l=r,t=0;!d&&u&&!o&&t<s.length;t++){var o,a=s[t],p=m.p,g=a[2];n>3?(o=g===r)&&(l=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=p&&((o=n<2&&p<a[1])?(i=0,m.v=r,m.n=a[1]):p<g&&(o=n<3||a[0]>r||r>g)&&(a[4]=n,a[5]=r,m.n=g,i=0))}if(o||n>1)return c;throw d=!0,r}return function(o,s,g){if(u>1)throw TypeError("Generator is already running");for(d&&1===s&&p(s,g),i=s,l=g;(t=i<2?e:l)||!d;){a||(i?i<3?(i>1&&(m.n=-1),p(i,l)):m.n=l:m.v=l);try{if(u=2,a){if(i||(o="next"),t=a[o]){if(!(t=t.call(a,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=e}else if((t=(d=m.n<0)?l:n.call(r,m))!==c)break}catch(t){a=e,i=1,l=t}finally{u=1}}return{value:t,done:d}}}(n,o,i),!0),s}var c={};function u(){}function s(){}function d(){}t=Object.getPrototypeOf;var m=[][r]?t(t([][r]())):(a(t={},r,function(){return this}),t),p=d.prototype=u.prototype=Object.create(m);function g(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,a(e,i,"GeneratorFunction")),e.prototype=Object.create(p),e}return s.prototype=d,a(p,"constructor",d),a(d,"constructor",s),s.displayName="GeneratorFunction",a(d,i,"GeneratorFunction"),a(p),a(p,i,"Generator"),a(p,r,function(){return this}),a(p,"toString",function(){return"[object Generator]"}),(o=function(){return{w:l,m:g}})()}function a(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}a=function(e,t,n,r){function i(t,n){a(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},a(e,t,n,r)}function i(e,t,n,r,o,a,i){try{var l=e[a](i),c=l.value}catch(e){return void n(e)}l.done?t(c):Promise.resolve(c).then(r,o)}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach(function(t){u(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function u(e,t,n){return(t=p(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e){return function(e){if(Array.isArray(e))return d(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return d(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?d(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function m(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,p(r.key),r)}}function p(e){var t=function(e,t){if("object"!=r(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,t||"default");if("object"!=r(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==r(t)?t:t+""}var g=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t},t=[{key:"cloneGameState",value:function(e){var t,n,r,o;if(logger.debug("Cloning game state:",e),!e.text_grid||!e.game_map)return logger.error("Invalid game state - missing text_grid or game_map:",e),null;var a={text_grid:e.text_grid.map(function(e){return s(e)}),game_map:e.game_map.map(function(e){return s(e)}),player1:c({},e.player1),player2:c({},e.player2),pearl_position:c({},e.pearl_position),current_player:e.current_player,is_completed:e.is_completed,winner:e.winner,map:e.map};return logger.debug("ðŸŽ­ CHARACTER DEBUG - Original characters:",{player1Character:null===(t=e.player1)||void 0===t?void 0:t.character,player2Character:null===(n=e.player2)||void 0===n?void 0:n.character}),logger.debug("ðŸŽ­ CHARACTER DEBUG - Cloned characters:",{player1Character:null===(r=a.player1)||void 0===r?void 0:r.character,player2Character:null===(o=a.player2)||void 0===o?void 0:o.character}),logger.debug("Cloned game state:",a),a}},{key:"initializeClientGameState",value:function(){var e=this;void 0===window.gameState&&(window.gameState={isActive:!1,currentRow:0,currentCol:0,preferredColumn:0,gameMap:[],textGrid:[],score:0}),window.updateClientGameState=function(t){e.game.clientGameState&&(window.gameState.currentRow=e.game.getCurrentPlayerPosition().row,window.gameState.currentCol=e.game.getCurrentPlayerPosition().col,window.gameState.preferredColumn=e.game.preferredColumn,window.gameState.gameMap=e.game.clientGameState.game_map,window.gameState.textGrid=e.game.clientGameState.text_grid,window.gameState.score=e.game.getCurrentPlayerScore())}}},{key:"updateClientGameStateForPrediction",value:function(){if(this.game.clientGameState&&window.gameState){var e=this.game.getCurrentPlayerPosition();window.gameState.currentRow=e.row,window.gameState.currentCol=e.col,window.gameState.preferredColumn=this.game.preferredColumn,window.gameState.gameMap=this.game.clientGameState.game_map,window.gameState.textGrid=this.game.clientGameState.text_grid,window.gameState.score=this.game.getCurrentPlayerScore(),"function"==typeof window.updateClientGameState&&window.updateClientGameState()}}},{key:"loadGameState",value:(r=o().m(function e(){var t,n,r,a,i,l,c,u,s,d=this;return o().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,logger.debug("Loading game state for match ID:",this.game.matchId),this.game.updateConnectionStatus("connecting","Loading game..."),e.n=1,fetch("/api/multiplayer/game?match_id=".concat(this.game.matchId));case 1:if(i=e.v,logger.debug("Response status:",i.status),i.ok){e.n=2;break}throw new Error("HTTP error! status: ".concat(i.status));case 2:return e.n=3,i.json();case 3:if(l=e.v,logger.debug("Game data received:",l),logger.debug("ðŸŽ­ CHARACTER DEBUG - Received character data:",{player1Character:null===(t=l.player1)||void 0===t?void 0:t.character,player2Character:null===(n=l.player2)||void 0===n?void 0:n.character,player1ID:null===(r=l.player1)||void 0===r?void 0:r.id,player2ID:null===(a=l.player2)||void 0===a?void 0:a.id,currentPlayerID:l.current_player}),!l.success){e.n=5;break}if(this.game.gameId=l.game_id,this.game.playerId=l.current_player,this.game.gameState=l,this.game.clientGameState=this.cloneGameState(l),this.game.clientGameState){e.n=4;break}throw new Error("Failed to clone game state - invalid data structure");case 4:logger.debug("Game state loaded successfully:",{gameId:this.game.gameId,playerId:this.game.playerId,textGrid:null===(c=this.game.clientGameState.text_grid)||void 0===c?void 0:c.length,gameMap:null===(u=this.game.clientGameState.game_map)||void 0===u?void 0:u.length}),this.game.updateConnectionStatus("connected","Connected"),this.game.displayManager.hideLoading(),this.game.displayManager.showGameContent(),this.game.displayManager.updateGameDisplay(),this.game.lastRenderedPositions={player1:null,player2:null,pearl:null},setTimeout(function(){logger.debug("ðŸŽ¬ FORCING INITIAL RENDER"),d.game.displayManager.updateGameMapOptimized()},100),this.updateClientGameStateForPrediction(),setTimeout(function(){void 0!==window.responsiveScaling&&"function"==typeof window.responsiveScaling.initializeResponsiveScaling?(logger.debug("Initializing responsive scaling for multiplayer..."),window.responsiveScaling.initializeResponsiveScaling()):"function"==typeof initializeResponsiveScaling?(logger.debug("Initializing responsive scaling (global function)..."),initializeResponsiveScaling()):logger.warn("Responsive scaling not available")},300),this.game.websocketManager.setupWebSocket(),e.n=6;break;case 5:throw new Error(l.error||"Failed to load game");case 6:e.n=8;break;case 7:e.p=7,s=e.v,logger.error("Error loading game state:",s),this.game.displayManager.showError("Failed to load game: "+s.message);case 8:return e.a(2)}},e,this,[[0,7]])}),a=function(){var e=this,t=arguments;return new Promise(function(n,o){var a=r.apply(e,t);function l(e){i(a,n,o,l,c,"next",e)}function c(e){i(a,n,o,l,c,"throw",e)}l(void 0)})},function(){return a.apply(this,arguments)})}],t&&m(e.prototype,t),n&&m(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,r,a}();function f(e){return f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},f(e)}function y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,h(r.key),r)}}function h(e){var t=function(e,t){if("object"!=f(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=f(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==f(t)?t:t+""}var v=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.keyboardHandler=t,this.game=t.game,this.numberPrefix="",this.accumulatingNumber=!1},(t=[{key:"handleNumberInput",value:function(e){return"0"===e&&""===this.numberPrefix?(logger.debug("ðŸ”¢ Processing 0 as movement command"),this.keyboardHandler.processMovement(e,1,!1),!0):(this.numberPrefix.length>=4||(this.numberPrefix+=e,this.accumulatingNumber=!0,logger.debug("ðŸ”¢ NUMBER PREFIX ACCUMULATED:",this.numberPrefix)),!0)}},{key:"getCountAndReset",value:function(){var e=""===this.numberPrefix?1:parseInt(this.numberPrefix),t=""!==this.numberPrefix;return this.numberPrefix="",this.accumulatingNumber=!1,{count:e,hasExplicitCount:t}}},{key:"clearPrefix",value:function(){this.numberPrefix="",this.accumulatingNumber=!1}},{key:"shouldHandleNumberInput",value:function(e){return!this.keyboardHandler.specialCommandHandler.isWaitingForInput()&&/^[0-9]$/.test(e)}}])&&y(e.prototype,t),n&&y(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}();function b(e){return b="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},b(e)}function w(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,S(r.key),r)}}function S(e){var t=function(e,t){if("object"!=b(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=b(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==b(t)?t:t+""}var P=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.keyboardHandler=t,this.game=t.game,this.waitingForChar=!1,this.charSearchMotion=null,this.waitingForGCommand=!1},(t=[{key:"isWaitingForInput",value:function(){return this.waitingForChar||this.waitingForGCommand}},{key:"handleCharSearchCompletion",value:function(e,t){if(1===e.length){var n=this.getCharSearchDirection(this.charSearchMotion,e),r=this.keyboardHandler.numberPrefixHandler.getCountAndReset(),o=r.count,a=r.hasExplicitCount;return this.waitingForChar=!1,this.charSearchMotion=null,this.keyboardHandler.processMovement(n,o,a),t.preventDefault(),!0}return"Escape"===e&&(this.clearStates(),t.preventDefault(),!0)}},{key:"handleGCommandCompletion",value:function(e,t){if(["Shift","Control","Alt","Meta"].includes(e))return!1;var n=this.keyboardHandler.numberPrefixHandler.getCountAndReset(),r=n.count,o=n.hasExplicitCount;return"g"===e?(logger.debug("ðŸŽ¯ G-COMMAND COMPLETE: gg",{count:r,hasExplicitCount:o}),this.waitingForGCommand=!1,this.keyboardHandler.processMovement("gg",r,o),t.preventDefault(),!0):"e"===e?(logger.debug("ðŸŽ¯ G-COMMAND COMPLETE: ge",{count:r,hasExplicitCount:o}),this.waitingForGCommand=!1,this.keyboardHandler.processMovement("ge",r,o),t.preventDefault(),!0):"E"===e?(logger.debug("ðŸŽ¯ G-COMMAND COMPLETE: gE",{count:r,hasExplicitCount:o}),this.waitingForGCommand=!1,this.keyboardHandler.processMovement("gE",r,o),t.preventDefault(),!0):"_"===e?(logger.debug("ðŸŽ¯ G-COMMAND COMPLETE: g_",{count:r,hasExplicitCount:o}),this.waitingForGCommand=!1,this.keyboardHandler.processMovement("g_",r,o),t.preventDefault(),!0):(logger.debug("ðŸŽ¯ G-COMMAND INVALID:",e),this.waitingForGCommand=!1,this.keyboardHandler.numberPrefixHandler.clearPrefix(),t.preventDefault(),!0)}},{key:"handleGCommandInitiation",value:function(e,t){return"g"===e&&(this.waitingForGCommand=!0,logger.debug("ðŸŽ¯ G-COMMAND: Waiting for G-command"),t.preventDefault(),!0)}},{key:"handleCharSearchInitiation",value:function(e,t){return!!["f","F","t","T"].includes(e)&&(this.waitingForChar=!0,this.charSearchMotion=e,logger.debug("Waiting for character search:",e),t.preventDefault(),!0)}},{key:"handleEscape",value:function(e,t){return"Escape"===e&&(logger.debug("ðŸ”¢ ESCAPE: Clearing all states",{waitingForChar:this.waitingForChar,waitingForGCommand:this.waitingForGCommand,numberPrefix:this.keyboardHandler.numberPrefixHandler.numberPrefix,accumulatingNumber:this.keyboardHandler.numberPrefixHandler.accumulatingNumber}),this.clearStates(),this.keyboardHandler.numberPrefixHandler.clearPrefix(),this.keyboardHandler.spaceCommandHandler.cleanup(),t.preventDefault(),!0)}},{key:"clearStates",value:function(){this.waitingForChar=!1,this.charSearchMotion=null,this.waitingForGCommand=!1}},{key:"getCharSearchDirection",value:function(e,t){switch(e){case"f":return"find_char_forward_".concat(t);case"F":return"find_char_backward_".concat(t);case"t":return"till_char_forward_".concat(t);case"T":return"till_char_backward_".concat(t);default:return e}}}])&&w(e.prototype,t),n&&w(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}(),E=n(812);function C(e){return C="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},C(e)}function M(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,k(r.key),r)}}function k(e){var t=function(e,t){if("object"!=C(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=C(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==C(t)?t:t+""}var O=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.keyboardHandler=t,this.game=t.game},(t=[{key:"handleMovementKey",value:function(e,t){if(E.Cs.includes(e)){var n=this.keyboardHandler.numberPrefixHandler.getCountAndReset(),r=n.count,o=n.hasExplicitCount,a=r>1?"".concat(r).concat(e):e;return logger.debug("ðŸ”¢ MOVEMENT WITH COUNT:",{key:e,numberPrefix:this.keyboardHandler.numberPrefixHandler.numberPrefix,parsedCount:r,hasExplicitCount:o,finalDirection:a}),this.keyboardHandler.processMovement(e,r,o),t.preventDefault(),!0}return!1}}])&&M(e.prototype,t),n&&M(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}();function G(e){return G="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},G(e)}function T(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,I(r.key),r)}}function I(e){var t=function(e,t){if("object"!=G(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=G(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==G(t)?t:t+""}var N=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.keyboardHandler=t,this.game=t.game,this.waitingForSpaceCommand=!1,this.spaceTimeout=null},(t=[{key:"shouldHandleSpaceCommand",value:function(e){return this.waitingForSpaceCommand||" "===e}},{key:"handleSpaceCommand",value:function(e){var t=this,n=e.key;if(this.waitingForSpaceCommand)switch(this.spaceTimeout&&(clearTimeout(this.spaceTimeout),this.spaceTimeout=null),this.waitingForSpaceCommand=!1,n.toLowerCase()){case"enter":return this.toggleCharacterVisibility(),e.preventDefault(),!0;case"n":return this.toggleLineNumbers(),e.preventDefault(),!0;case"r":return this.toggleRelativeLineNumbers(),e.preventDefault(),!0;case" ":return this.toggleSpaceHighlight(),e.preventDefault(),!0;case"f":return this.toggleFullscreen(),e.preventDefault(),!0;default:return e.preventDefault(),!0}return" "===n&&(this.waitingForSpaceCommand=!0,this.spaceTimeout=setTimeout(function(){t.waitingForSpaceCommand=!1,t.spaceTimeout=null},1e3),e.preventDefault(),!0)}},{key:"toggleLineNumbers",value:function(){if(window.lineNumbersModule&&window.lineNumbersModule.toggleLineNumbers){window.relativeLineNumbersModule&&window.relativeLineNumbersModule.areRelativeLineNumbersVisible()&&(window.relativeLineNumbersModule.hideRelativeLineNumbers(),window.userPreferencesModule&&window.userPreferencesModule.updatePreference("relativeLineNumbers",!1));var e=window.lineNumbersModule.toggleLineNumbers();if(window.feedbackModule&&window.feedbackModule.showMovementFeedback&&window.feedbackModule.showMovementFeedback(e,1),window.userPreferencesModule){var t=window.lineNumbersModule.areLineNumbersVisible();window.userPreferencesModule.updatePreference("lineNumbers",t)}logger.debug("ðŸ”¢ Multiplayer: Toggled line numbers -",e)}}},{key:"toggleRelativeLineNumbers",value:function(){if(window.relativeLineNumbersModule&&window.relativeLineNumbersModule.toggleRelativeLineNumbers){window.lineNumbersModule&&window.lineNumbersModule.areLineNumbersVisible()&&(window.lineNumbersModule.hideLineNumbers(),window.userPreferencesModule&&window.userPreferencesModule.updatePreference("lineNumbers",!1));var e=window.relativeLineNumbersModule.toggleRelativeLineNumbers();if(window.feedbackModule&&window.feedbackModule.showMovementFeedback&&window.feedbackModule.showMovementFeedback(e,1),window.userPreferencesModule){var t=window.relativeLineNumbersModule.areRelativeLineNumbersVisible();window.userPreferencesModule.updatePreference("relativeLineNumbers",t)}logger.debug("ðŸ”¢ Multiplayer: Toggled relative line numbers -",e)}}},{key:"toggleSpaceHighlight",value:function(){if(window.spaceHighlightModule&&window.spaceHighlightModule.toggleSpaceHighlight){var e=window.spaceHighlightModule.toggleSpaceHighlight();if(window.feedbackModule&&window.feedbackModule.showMovementFeedback&&window.feedbackModule.showMovementFeedback(e,1),window.userPreferencesModule){var t=window.spaceHighlightModule.isSpaceHighlightActive();window.userPreferencesModule.updatePreference("spaceHighlighting",t)}logger.debug("âŽµ Multiplayer: Toggled space highlighting -",e)}}},{key:"toggleFullscreen",value:function(){window.fullscreenModule&&window.fullscreenModule.toggleFullscreen&&(window.fullscreenModule.toggleFullscreen(),logger.debug("ðŸ–¥ï¸ Multiplayer: Toggled fullscreen"))}},{key:"toggleCharacterVisibility",value:function(){n.e(664).then(n.bind(n,664)).then(function(e){var t=e.toggleSpriteVisibility();if(window.feedbackModule&&window.feedbackModule.showMovementFeedback&&window.feedbackModule.showMovementFeedback(t,1),window.userPreferencesModule&&window.spriteVisibilityModule){var n=!window.spriteVisibilityModule.areSpritesHidden();window.userPreferencesModule.updatePreference("characterVisible",n)}logger.debug("ðŸ‘¤ Multiplayer: Toggled character visibility -",t)}).catch(function(e){logger.warn("Could not load sprite visibility module:",e)})}},{key:"cleanup",value:function(){this.spaceTimeout&&(clearTimeout(this.spaceTimeout),this.spaceTimeout=null),this.waitingForSpaceCommand=!1}}])&&T(e.prototype,t),r&&T(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,r}();function A(e){return A="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},A(e)}function j(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,_(r.key),r)}}function _(e){var t=function(e,t){if("object"!=A(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=A(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==A(t)?t:t+""}var R=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.numberPrefixHandler=new v(this),this.specialCommandHandler=new P(this),this.movementHandler=new O(this),this.spaceCommandHandler=new N(this)},t=[{key:"setupKeyboardControls",value:function(){var e=this;document.addEventListener("keydown",function(t){e.game.isConnected&&e.game.clientGameState&&e.handleKeydown(t)})}},{key:"handleKeydown",value:function(e){var t=e.key;logger.debug("ðŸŽ¹ MULTIPLAYER KEYDOWN:",t,"isConnected:",this.game.isConnected,"hasClientGameState:",!!this.game.clientGameState),this.numberPrefixHandler.shouldHandleNumberInput(t)&&this.numberPrefixHandler.handleNumberInput(t)?e.preventDefault():this.specialCommandHandler.waitingForChar&&this.specialCommandHandler.handleCharSearchCompletion(t,e)||this.specialCommandHandler.waitingForGCommand&&this.specialCommandHandler.handleGCommandCompletion(t,e)||this.specialCommandHandler.handleGCommandInitiation(t,e)||this.specialCommandHandler.handleCharSearchInitiation(t,e)||this.spaceCommandHandler.shouldHandleSpaceCommand(t)&&this.spaceCommandHandler.handleSpaceCommand(e)||this.movementHandler.handleMovementKey(t,e)||this.specialCommandHandler.handleEscape(t,e)}},{key:"processMovement",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];logger.debug("ðŸŽ® PROCESS MOVEMENT:",{direction:e,count:t,hasExplicitCount:n,numberPrefixState:this.numberPrefixHandler.numberPrefix}),this.game.movementProcessor.queueMove(e,t,n)}}],t&&j(e.prototype,t),n&&j(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}();function D(e){return D="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},D(e)}function x(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,L(r.key),r)}}function L(e){var t=function(e,t){if("object"!=D(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=D(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==D(t)?t:t+""}var B=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.movementProcessor=t,this.game=t.game,this.moveQueue=[],this.isProcessingMove=!1,this.batchQueue=[],this.batchTimeout=null,this.BATCH_DELAY=50,this.MAX_BATCH_SIZE=10},t=[{key:"queueMove",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.game.countdownActive?this.showMoveBlocked(e):this.movementProcessor.clientPredictor.processMoveWithPrediction(e,t,n)}},{key:"showMoveBlocked",value:function(e){logger.debug("Move blocked:",e)}}],t&&x(e.prototype,t),n&&x(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}(),H=n(147),F=n(312);function U(e){return U="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},U(e)}function z(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function a(n,r,o,a){var c=r&&r.prototype instanceof l?r:l,u=Object.create(c.prototype);return W(u,"_invoke",function(n,r,o){var a,l,c,u=0,s=o||[],d=!1,m={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,n){return a=t,l=0,c=e,m.n=n,i}};function p(n,r){for(l=n,c=r,t=0;!d&&u&&!o&&t<s.length;t++){var o,a=s[t],p=m.p,g=a[2];n>3?(o=g===r)&&(c=a[(l=a[4])?5:(l=3,3)],a[4]=a[5]=e):a[0]<=p&&((o=n<2&&p<a[1])?(l=0,m.v=r,m.n=a[1]):p<g&&(o=n<3||a[0]>r||r>g)&&(a[4]=n,a[5]=r,m.n=g,l=0))}if(o||n>1)return i;throw d=!0,r}return function(o,s,g){if(u>1)throw TypeError("Generator is already running");for(d&&1===s&&p(s,g),l=s,c=g;(t=l<2?e:c)||!d;){a||(l?l<3?(l>1&&(m.n=-1),p(l,c)):m.n=c:m.v=c);try{if(u=2,a){if(l||(o="next"),t=a[o]){if(!(t=t.call(a,c)))throw TypeError("iterator result is not an object");if(!t.done)return t;c=t.value,l<2&&(l=0)}else 1===l&&(t=a.return)&&t.call(a),l<2&&(c=TypeError("The iterator does not provide a '"+o+"' method"),l=1);a=e}else if((t=(d=m.n<0)?c:n.call(r,m))!==i)break}catch(t){a=e,l=1,c=t}finally{u=1}}return{value:t,done:d}}}(n,o,a),!0),u}var i={};function l(){}function c(){}function u(){}t=Object.getPrototypeOf;var s=[][r]?t(t([][r]())):(W(t={},r,function(){return this}),t),d=u.prototype=l.prototype=Object.create(s);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,W(e,o,"GeneratorFunction")),e.prototype=Object.create(d),e}return c.prototype=u,W(d,"constructor",u),W(u,"constructor",c),c.displayName="GeneratorFunction",W(u,o,"GeneratorFunction"),W(d),W(d,o,"Generator"),W(d,r,function(){return this}),W(d,"toString",function(){return"[object Generator]"}),(z=function(){return{w:a,m}})()}function W(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}W=function(e,t,n,r){function a(t,n){W(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},W(e,t,n,r)}function q(e,t,n,r,o,a,i){try{var l=e[a](i),c=l.value}catch(e){return void n(e)}l.done?t(c):Promise.resolve(c).then(r,o)}function V(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,Y(r.key),r)}}function Y(e){var t=function(e,t){if("object"!=U(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=U(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==U(t)?t:t+""}var J=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.movementProcessor=t,this.game=t.game,this.moveSequence=0},t=[{key:"processMoveWithPrediction",value:(r=z().m(function e(t){var n,r,o,a,i,l,c,u=arguments;return z().w(function(e){for(;;)switch(e.n){case 0:if(n=u.length>1&&void 0!==u[1]?u[1]:1,r=u.length>2&&void 0!==u[2]&&u[2],this.game.isConnected&&this.game.clientGameState&&!this.game.countdownActive){e.n=1;break}return this.game.countdownActive&&this.movementProcessor.moveQueue.showMoveBlocked(t),e.a(2);case 1:if(this.game.clientGameState.text_grid&&this.game.clientGameState.game_map){e.n=2;break}return e.a(2);case 2:if(o=this.moveSequence++,a=this.game.playerId===this.game.clientGameState.player1.id,(i=a?this.game.clientGameState.player1:this.game.clientGameState.player2)&&i.position){e.n=3;break}return logger.error("Cannot process move - invalid player data"),e.a(2);case 3:l=i.position;try{(c=(0,H.Rb)(t,l.row,l.col,this.game.clientGameState.game_map,this.game.clientGameState.text_grid,this.game.preferredColumn,n,r)).success&&c.finalPosition?this.applyPrediction(c,i,o,t,n,r):(this.movementProcessor.moveQueue.showMoveBlocked(t),F.R.playBlockedMovementSound())}catch(e){this.movementProcessor.moveQueue.showMoveBlocked(t),F.R.playBlockedMovementSound()}case 4:return e.a(2)}},e,this)}),o=function(){var e=this,t=arguments;return new Promise(function(n,o){var a=r.apply(e,t);function i(e){q(a,n,o,i,l,"next",e)}function l(e){q(a,n,o,i,l,"throw",e)}i(void 0)})},function(e){return o.apply(this,arguments)})},{key:"applyPrediction",value:function(e,t,n,r,o,a){var i,l,c=e.finalPosition,u=null===(i=this.game.clientGameState.player1)||void 0===i?void 0:i.character,s=null===(l=this.game.clientGameState.player2)||void 0===l?void 0:l.character;t.position={row:c.newRow,col:c.newCol},this.game.clientGameState.player1&&(this.game.clientGameState.player1.character=u),this.game.clientGameState.player2&&(this.game.clientGameState.player2.character=s),this.game.preferredColumn=c.preferredColumn,this.game.displayManager.updateClientGameMap(),this.game.displayManager.throttledDisplayUpdate(),this.movementProcessor.stateReconciler.addPendingMove({id:n,direction:r,count:o,hasExplicitCount:a,timestamp:Date.now()}),this.movementProcessor.serverCommunicator.sendMoveToServer(r,o,a,n)}},{key:"applyMoveToClientState",value:function(e,t,n){var r=this.game.playerId===this.game.clientGameState.player1.id?this.game.clientGameState.player1:this.game.clientGameState.player2,o=r.position,a=(0,H.Rb)(e,o.row,o.col,this.game.clientGameState.game_map,this.game.clientGameState.text_grid,this.game.preferredColumn,t,n);if(a.success&&a.finalPosition){var i=a.finalPosition;r.position={row:i.newRow,col:i.newCol},this.game.preferredColumn=i.preferredColumn;var l=this.game.clientGameState.pearl_position;i.newRow===l.row&&i.newCol===l.col&&(r.score+=50,this.generateNewPearl()),this.game.displayManager.updateClientGameMap()}}},{key:"generateNewPearl",value:function(){var e=this.game.clientGameState.text_grid,t=this.game.clientGameState.game_map;if(e&&0!==e.length){var n,r,o=0;do{n=Math.floor(Math.random()*e.length),r=Math.floor(Math.random()*e[n].length),o++}while(t[n]&&0!==t[n][r]&&o<100);this.game.clientGameState.pearl_position={row:n,col:r}}else logger.warn("Cannot generate pearl - no text grid available")}}],t&&V(e.prototype,t),n&&V(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,r,o}();function K(e){return K="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},K(e)}function $(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function a(n,r,o,a){var c=r&&r.prototype instanceof l?r:l,u=Object.create(c.prototype);return X(u,"_invoke",function(n,r,o){var a,l,c,u=0,s=o||[],d=!1,m={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,n){return a=t,l=0,c=e,m.n=n,i}};function p(n,r){for(l=n,c=r,t=0;!d&&u&&!o&&t<s.length;t++){var o,a=s[t],p=m.p,g=a[2];n>3?(o=g===r)&&(c=a[(l=a[4])?5:(l=3,3)],a[4]=a[5]=e):a[0]<=p&&((o=n<2&&p<a[1])?(l=0,m.v=r,m.n=a[1]):p<g&&(o=n<3||a[0]>r||r>g)&&(a[4]=n,a[5]=r,m.n=g,l=0))}if(o||n>1)return i;throw d=!0,r}return function(o,s,g){if(u>1)throw TypeError("Generator is already running");for(d&&1===s&&p(s,g),l=s,c=g;(t=l<2?e:c)||!d;){a||(l?l<3?(l>1&&(m.n=-1),p(l,c)):m.n=c:m.v=c);try{if(u=2,a){if(l||(o="next"),t=a[o]){if(!(t=t.call(a,c)))throw TypeError("iterator result is not an object");if(!t.done)return t;c=t.value,l<2&&(l=0)}else 1===l&&(t=a.return)&&t.call(a),l<2&&(c=TypeError("The iterator does not provide a '"+o+"' method"),l=1);a=e}else if((t=(d=m.n<0)?c:n.call(r,m))!==i)break}catch(t){a=e,l=1,c=t}finally{u=1}}return{value:t,done:d}}}(n,o,a),!0),u}var i={};function l(){}function c(){}function u(){}t=Object.getPrototypeOf;var s=[][r]?t(t([][r]())):(X(t={},r,function(){return this}),t),d=u.prototype=l.prototype=Object.create(s);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,X(e,o,"GeneratorFunction")),e.prototype=Object.create(d),e}return c.prototype=u,X(d,"constructor",u),X(u,"constructor",c),c.displayName="GeneratorFunction",X(u,o,"GeneratorFunction"),X(d),X(d,o,"Generator"),X(d,r,function(){return this}),X(d,"toString",function(){return"[object Generator]"}),($=function(){return{w:a,m}})()}function X(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}X=function(e,t,n,r){function a(t,n){X(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},X(e,t,n,r)}function Q(e,t,n,r,o,a,i){try{var l=e[a](i),c=l.value}catch(e){return void n(e)}l.done?t(c):Promise.resolve(c).then(r,o)}function Z(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,ee(r.key),r)}}function ee(e){var t=function(e,t){if("object"!=K(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=K(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==K(t)?t:t+""}var te=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.movementProcessor=t,this.game=t.game},t=[{key:"sendMoveToServer",value:(r=$().m(function e(t,n,r,o){var a,i,l,c,u;return $().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,logger.debug("ðŸ“¡ SENDING MOVE TO SERVER:",{gameId:this.game.gameId,direction:t,count:n,hasExplicitCount:r,moveId:o,actualPayload:{direction:t,count:n,has_explicit_count:r,move_id:o}}),a=new AbortController,i=setTimeout(function(){return a.abort()},2e3),e.n=1,fetch("/api/multiplayer/game/".concat(this.game.gameId,"/move"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({direction:t,count:n,has_explicit_count:r,move_id:o}),signal:a.signal});case 1:if(l=e.v,clearTimeout(i),logger.debug("Server response status:",l.status),l.ok){e.n=2;break}throw new Error("HTTP error! status: ".concat(l.status));case 2:return e.n=3,l.json();case 3:c=e.v,logger.debug("Server response data:",c),c.success?(this.movementProcessor.stateReconciler.reconcileServerStateOptimized(c,o),c.completed&&this.game.gameCompletionHandler.handleGameCompletion(c)):(logger.warn("Server rejected move:",c.error),this.movementProcessor.stateReconciler.rollbackMove(o)),e.n=5;break;case 4:e.p=4,"AbortError"===(u=e.v).name?logger.warn("Move request timed out:",o):logger.error("Error sending move to server:",u),this.movementProcessor.stateReconciler.rollbackMove(o);case 5:return e.a(2)}},e,this,[[0,4]])}),o=function(){var e=this,t=arguments;return new Promise(function(n,o){var a=r.apply(e,t);function i(e){Q(a,n,o,i,l,"next",e)}function l(e){Q(a,n,o,i,l,"throw",e)}i(void 0)})},function(e,t,n,r){return o.apply(this,arguments)})}],t&&Z(e.prototype,t),n&&Z(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,r,o}();function ne(e){return ne="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ne(e)}function re(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return oe(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?oe(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}function oe(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function ae(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,ie(r.key),r)}}function ie(e){var t=function(e,t){if("object"!=ne(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=ne(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==ne(t)?t:t+""}var le=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.movementProcessor=t,this.game=t.game,this.pendingMoves=[]},(t=[{key:"addPendingMove",value:function(e){this.pendingMoves.push(e)}},{key:"reconcileServerStateOptimized",value:function(e,t){var n,r;this.pendingMoves=this.pendingMoves.filter(function(e){return e.id!==t});var o=this.hasSignificantStateDifference(e),a=(null===(n=this.game.gameState)||void 0===n||null===(n=n.player1)||void 0===n?void 0:n.score)||0,i=(null===(r=this.game.gameState)||void 0===r||null===(r=r.player2)||void 0===r?void 0:r.score)||0;this.game.gameState=e;var l=this.game.playerId===e.player1.id;(l&&e.player1.score>a||!l&&e.player2.score>i)&&F.R.playPearlCollectedSound(),0===this.pendingMoves.length||o?(this.game.clientGameState=this.game.gameStateManager.cloneGameState(e),this.game.displayManager.updateGameDisplayOptimized()):this.updateNonPositionData(e)}},{key:"hasSignificantStateDifference",value:function(e){if(!this.game.clientGameState)return!0;var t=this.game.clientGameState.pearl_position,n=e.pearl_position;return!t||t.row!==n.row||t.col!==n.col||this.game.clientGameState.player1.score!==e.player1.score||this.game.clientGameState.player2.score!==e.player2.score}},{key:"updateNonPositionData",value:function(e){this.game.clientGameState.player1.score=e.player1.score,this.game.clientGameState.player2.score=e.player2.score,this.game.clientGameState.pearl_position=e.pearl_position;var t=document.getElementById("player1-score"),n=document.getElementById("player2-score");t&&(t.textContent=e.player1.score),n&&(n.textContent=e.player2.score)}},{key:"rollbackMove",value:function(e){this.pendingMoves=this.pendingMoves.filter(function(t){return t.id!==e}),this.game.clientGameState=this.game.gameStateManager.cloneGameState(this.game.gameState),this.reapplyPendingMoves(),this.game.displayManager.updateGameDisplayOptimized()}},{key:"reapplyPendingMoves",value:function(){var e,t=re(this.pendingMoves);try{for(t.s();!(e=t.n()).done;){var n=e.value;this.movementProcessor.clientPredictor.applyMoveToClientState(n.direction,n.count,n.hasExplicitCount)}}catch(e){t.e(e)}finally{t.f()}}}])&&ae(e.prototype,t),n&&ae(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}();function ce(e){return ce="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ce(e)}function ue(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,se(r.key),r)}}function se(e){var t=function(e,t){if("object"!=ce(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=ce(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==ce(t)?t:t+""}var de=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.moveQueue=new B(this),this.clientPredictor=new J(this),this.serverCommunicator=new te(this),this.stateReconciler=new le(this)},t=[{key:"queueMove",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.moveQueue.queueMove(e,t,n)}},{key:"pendingMoves",get:function(){return this.stateReconciler.pendingMoves}}],t&&ue(e.prototype,t),n&&ue(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}(),me=n(282);function pe(e){return pe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},pe(e)}function ge(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function fe(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ge(Object(n),!0).forEach(function(t){ye(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ge(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function ye(e,t,n){return(t=ve(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function he(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,ve(r.key),r)}}function ve(e){var t=function(e,t){if("object"!=pe(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=pe(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==pe(t)?t:t+""}var be=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.displayManager=t,this.game=t.game},(t=[{key:"updateClientGameMap",value:function(){var e,t,n,r,o,a,i,l,c,u,s,d,m,p=null===(e=this.game.clientGameState.player1)||void 0===e?void 0:e.position,g=null===(t=this.game.clientGameState.player2)||void 0===t?void 0:t.position,f=this.game.clientGameState.pearl_position;logger.debug("ðŸ—ºï¸ UPDATING CLIENT GAME MAP WITH POSITIONS:",{player1:p,player2:g,pearl:f}),logger.debug("ðŸŽ­ CHARACTER DATA IN updateClientGameMap:",{player1Character:null===(n=this.game.clientGameState.player1)||void 0===n?void 0:n.character,player2Character:null===(r=this.game.clientGameState.player2)||void 0===r?void 0:r.character,currentPlayerId:this.game.playerId,player1Id:null===(o=this.game.clientGameState.player1)||void 0===o?void 0:o.id,player2Id:null===(a=this.game.clientGameState.player2)||void 0===a?void 0:a.id});for(var y=this.game.clientGameState.game_map,h=0,v=0;v<y.length;v++)for(var b=0;b<y[v].length;b++)1!==y[v][b]&&2!==y[v][b]&&3!==y[v][b]||(y[v][b]=0,h++);logger.debug("ðŸ§¹ Cleared",h,"cells from game map");var w=this.game.playerId===(null===(i=this.game.clientGameState.player1)||void 0===i?void 0:i.id);if(logger.debug("ðŸŽ¯ DETAILED PLAYER IDENTIFICATION:",{currentPlayerId:this.game.playerId,player1Id:null===(l=this.game.clientGameState.player1)||void 0===l?void 0:l.id,player2Id:null===(c=this.game.clientGameState.player2)||void 0===c?void 0:c.id,isPlayer1:w,player1Character:null===(u=this.game.clientGameState.player1)||void 0===u?void 0:u.character,player2Character:null===(s=this.game.clientGameState.player2)||void 0===s?void 0:s.character,player1Position:null===(d=this.game.clientGameState.player1)||void 0===d?void 0:d.position,player2Position:null===(m=this.game.clientGameState.player2)||void 0===m?void 0:m.position}),logger.debug("ðŸŽ¯ Setting positions - P1:",p,"P2:",g,"Pearl:",f),f&&f.row>=0&&f.row<y.length&&f.col>=0&&f.col<y[f.row].length?(y[f.row][f.col]=3,logger.debug("âœ… Set Pearl at",f)):f&&logger.error("âŒ Invalid Pearl position:",f),w){if(logger.debug("ðŸŽ¯ SETTING P2 AS ENEMY (RED):",g),g&&g.row>=0&&g.row<y.length&&g.col>=0&&g.col<y[g.row].length)y[g.row][g.col]=2,logger.debug("âœ… Set Enemy Player (P2) at",JSON.stringify(g),"with RED color (value 2) - gameMap["+g.row+"]["+g.col+"] = 2"),logger.debug("ðŸ” VERIFICATION: gameMap["+g.row+"]["+g.col+"] =",y[g.row][g.col]);else if(g){var S;logger.error("âŒ Invalid Enemy Player (P2) position:",JSON.stringify(g)),logger.error("âŒ GameMap bounds:",y.length,"rows, row",g.row,"has",null===(S=y[g.row])||void 0===S?void 0:S.length,"cols")}logger.debug("ðŸŽ¯ SETTING P1 AS CURRENT (GREEN):",p),p&&p.row>=0&&p.row<y.length&&p.col>=0&&p.col<y[p.row].length?(y[p.row][p.col]=1,logger.debug("âœ… Set Current Player (P1) at",JSON.stringify(p),"with GREEN color (value 1) - gameMap["+p.row+"]["+p.col+"] = 1"),logger.debug("ðŸ” VERIFICATION: gameMap["+p.row+"]["+p.col+"] =",y[p.row][p.col])):p&&logger.error("âŒ Invalid Current Player (P1) position:",JSON.stringify(p))}else{if(logger.debug("ðŸŽ¯ SETTING P1 AS ENEMY (RED):",p),p&&p.row>=0&&p.row<y.length&&p.col>=0&&p.col<y[p.row].length)y[p.row][p.col]=2,logger.debug("âœ… Set Enemy Player (P1) at",JSON.stringify(p),"with RED color (value 2) - gameMap["+p.row+"]["+p.col+"] = 2"),logger.debug("ðŸ” VERIFICATION: gameMap["+p.row+"]["+p.col+"] =",y[p.row][p.col]);else if(p){var P;logger.error("âŒ Invalid Enemy Player (P1) position:",JSON.stringify(p)),logger.error("âŒ GameMap bounds:",y.length,"rows, row",p.row,"has",null===(P=y[p.row])||void 0===P?void 0:P.length,"cols")}logger.debug("ðŸŽ¯ SETTING P2 AS CURRENT (GREEN):",g),g&&g.row>=0&&g.row<y.length&&g.col>=0&&g.col<y[g.row].length?(y[g.row][g.col]=1,logger.debug("âœ… Set Current Player (P2) at",JSON.stringify(g),"with GREEN color (value 1) - gameMap["+g.row+"]["+g.col+"] = 1"),logger.debug("ðŸ” VERIFICATION: gameMap["+g.row+"]["+g.col+"] =",y[g.row][g.col])):g&&logger.error("âŒ Invalid Current Player (P2) position:",JSON.stringify(g))}logger.debug("âœ… Game map updated with color-coded positions (1=current/green, 2=enemy/red, 3=pearl)")}},{key:"updateGameMapOptimized",value:function(){var e,t,n;if(this.game.clientGameState&&this.game.clientGameState.text_grid&&this.game.clientGameState.game_map){var r=document.getElementById("multiplayer-game-map");if(r&&0!==r.children.length){var o=null===(e=this.game.clientGameState.player1)||void 0===e?void 0:e.position,a=null===(t=this.game.clientGameState.player2)||void 0===t?void 0:t.position,i=this.game.clientGameState.pearl_position,l=!this.displayManager.displayUtils.positionsEqual(this.game.lastRenderedPositions.player1,o),c=!this.displayManager.displayUtils.positionsEqual(this.game.lastRenderedPositions.player2,a),u=!this.displayManager.displayUtils.positionsEqual(this.game.lastRenderedPositions.pearl,i);if(logger.debug("ðŸ” Position changes - P1:",l,"P2:",c,"Pearl:",u),l||c||u){logger.debug("ðŸš€ OPTIMIZED UPDATE - only redrawing changed elements:",{p1Changed:l,p2Changed:c,pearlChanged:u}),this.displayManager.needsInitialCleanup&&(logger.debug("ðŸ”„ Performing initial cleanup of static positions"),this.displayManager.displayUtils.clearAllStaticHighlights(),this.displayManager.needsInitialCleanup=!1);var s=this.game.playerId===(null===(n=this.game.clientGameState.player1)||void 0===n?void 0:n.id);if(l){if(this.game.lastRenderedPositions.player1&&(this.displayManager.spriteManager.clearPositionSprite(this.game.lastRenderedPositions.player1,"player1"),logger.debug("ðŸ§¹ Cleared P1 from old position:",this.game.lastRenderedPositions.player1)),o){var d,m=(null===(d=this.game.clientGameState.player1)||void 0===d?void 0:d.character)||"boba";s?(logger.debug("âœ… P1 â†’ Current (GREEN):",m),this.displayManager.spriteManager.addSpriteAtPosition(o.row,o.col,"current",m)):(logger.debug("ðŸ”´ P1 â†’ Enemy (RED):",m),this.displayManager.spriteManager.addSpriteAtPosition(o.row,o.col,"enemy",m))}this.game.lastRenderedPositions.player1=o?fe({},o):null}if(c){if(this.game.lastRenderedPositions.player2&&(this.displayManager.spriteManager.clearPositionSprite(this.game.lastRenderedPositions.player2,"player2"),logger.debug("ðŸ§¹ Cleared P2 from old position:",this.game.lastRenderedPositions.player2)),a){var p,g=(null===(p=this.game.clientGameState.player2)||void 0===p?void 0:p.character)||"boba";s?(logger.debug("ðŸ”´ P2 â†’ Enemy (RED):",g),this.displayManager.spriteManager.addSpriteAtPosition(a.row,a.col,"enemy",g)):(logger.debug("âœ… P2 â†’ Current (GREEN):",g),this.displayManager.spriteManager.addSpriteAtPosition(a.row,a.col,"current",g))}this.game.lastRenderedPositions.player2=a?fe({},a):null}u&&(this.game.lastRenderedPositions.pearl&&(this.displayManager.spriteManager.clearPositionSprite(this.game.lastRenderedPositions.pearl,"pearl"),logger.debug("ðŸ§¹ Cleared Pearl from old position:",this.game.lastRenderedPositions.pearl)),i&&(logger.debug("ðŸ’Ž Pearl moved to:",i),this.displayManager.spriteManager.addSpriteAtPosition(i.row,i.col,"pearl")),this.game.lastRenderedPositions.pearl=i?fe({},i):null)}else logger.debug("âš¡ No position changes, skipping ALL updates for maximum efficiency")}else this.updateGameMap()}else logger.error("âŒ Cannot update map - missing game state data")}},{key:"updateGameMap",value:function(){var e,t,n,r,o=this;if(this.game.clientGameState&&this.game.clientGameState.text_grid&&this.game.clientGameState.game_map){var a=document.getElementById("multiplayer-game-map");if(a){logger.debug("ðŸ—ºï¸ UPDATING VISUAL MAP - clearing and rebuilding"),logger.debug("ðŸŽ¯ Current positions - P1:",JSON.stringify(null===(e=this.game.clientGameState.player1)||void 0===e?void 0:e.position),"P2:",JSON.stringify(null===(t=this.game.clientGameState.player2)||void 0===t?void 0:t.position),"Pearl:",JSON.stringify(this.game.clientGameState.pearl_position));var i=this.game.clientGameState.game_map,l=null===(n=this.game.clientGameState.player1)||void 0===n?void 0:n.position,c=null===(r=this.game.clientGameState.player2)||void 0===r?void 0:r.position;logger.debug("ðŸ—ºï¸ MAP VALUES AT POSITIONS:"),l&&i[l.row]&&void 0!==i[l.row][l.col]&&logger.debug("P1 position (".concat(l.row,",").concat(l.col,") has map value: ").concat(i[l.row][l.col])),c&&i[c.row]&&void 0!==i[c.row][c.col]&&logger.debug("P2 position (".concat(c.row,",").concat(c.col,") has map value: ").concat(i[c.row][c.col])),a.innerHTML="";var u=this.game.clientGameState.text_grid,s=0,d=0,m=0;u.forEach(function(e,t){var n=document.createElement("div");n.className="keyboard-row",e.forEach(function(e,r){var a=document.createElement("div");a.className="key",a.setAttribute("data-letter",e),a.setAttribute("data-row",t),a.setAttribute("data-col",r);var l=i[t]&&i[t][r]?i[t][r]:0;a.setAttribute("data-map",l);var c=document.createElement("div");c.className="key-top";var u=document.createElement("span");if(u.className="key-letter",u.textContent=e,c.appendChild(u),1===l){var p,g=o.game.playerId===(null===(p=o.game.clientGameState.player1)||void 0===p?void 0:p.id),f=g?o.game.clientGameState.player1:o.game.clientGameState.player2,y=null==f?void 0:f.character;logger.debug("ðŸŽ® Rendering CURRENT PLAYER (GREEN) at (".concat(t,", ").concat(r,") with character: ").concat(y,", PlayerID: ").concat(o.game.playerId,", IsPlayer1: ").concat(g));var h=document.createElement("div");h.className="boba-character current-player-character";var v=document.createElement("div");v.className="boba-shadow",h.appendChild(v);var b=document.createElement("img");b.className="boba-sprite",b.alt="Current Player",b.src=(0,me.o$)(y||"boba"),h.appendChild(b),c.appendChild(h),g?s++:d++}else if(2===l){var w,S,P,E=o.game.playerId===(null===(w=o.game.clientGameState.player1)||void 0===w?void 0:w.id),C=E?o.game.clientGameState.player2:o.game.clientGameState.player1,M=null==C?void 0:C.character;logger.debug("ðŸŽ® Rendering ENEMY PLAYER (RED) at (".concat(t,", ").concat(r,") with character: ").concat(M,", EnemyPlayerID: ").concat(E?null===(S=o.game.clientGameState.player2)||void 0===S?void 0:S.id:null===(P=o.game.clientGameState.player1)||void 0===P?void 0:P.id,", IsPlayer1Enemy: ").concat(!E));var k=document.createElement("div");k.className="boba-character enemy-player-character";var O=document.createElement("div");O.className="boba-shadow",k.appendChild(O);var G=document.createElement("img");G.className="boba-sprite",G.alt="Enemy Player",G.src=(0,me.o$)(M||"boba"),k.appendChild(G),c.appendChild(k),E?d++:s++}else if(3===l){logger.debug("ðŸ’Ž Rendering Pearl sprite at (".concat(t,", ").concat(r,")"));var T=document.createElement("div");T.className="pearl";var I=document.createElement("div");I.className="pearl-shadow",T.appendChild(I);var N=document.createElement("img");N.className="pearl-sprite",N.src="/static/sprites/character/pearl.png",N.alt="Pearl",T.appendChild(N),c.appendChild(T),m++}a.appendChild(c),n.appendChild(a)}),a.appendChild(n)}),logger.debug("ðŸŽ¯ RENDER SUMMARY: Actual P1=".concat(s,", Actual P2=").concat(d,", Pearl=").concat(m)),logger.debug("ðŸ” Map element child count:",a.children.length)}else logger.error("âŒ Cannot find multiplayer-game-map element")}else logger.error("âŒ Cannot update map - missing game state data")}}])&&he(e.prototype,t),n&&he(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}();function we(e){return we="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},we(e)}function Se(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,Pe(r.key),r)}}function Pe(e){var t=function(e,t){if("object"!=we(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=we(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==we(t)?t:t+""}var Ee=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.displayManager=t,this.game=t.game},t=[{key:"addSpriteAtPosition",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=document.getElementById("multiplayer-game-map");if(o){var a=o.querySelector('[data-row="'.concat(e,'"][data-col="').concat(t,'"] .key-top'));a?"current"===n?this.createPlayerSprite(a,e,t,"current-player-character","Current Player",r,"1"):"enemy"===n?this.createPlayerSprite(a,e,t,"enemy-player-character","Enemy Player",r,"2"):"pearl"===n&&this.createPearlSprite(a,e,t):logger.warn("Could not find key element at (".concat(e,", ").concat(t,")"))}}},{key:"createPlayerSprite",value:function(e,t,n,r,o,a,i){var l;logger.debug("ðŸŽ® Adding ".concat(o," sprite at (").concat(t,", ").concat(n,") with character: ").concat(a||"boba"));var c=document.createElement("div");c.className="boba-character ".concat(r);var u=this.game.playerId===(null===(l=this.game.clientGameState.player1)||void 0===l?void 0:l.id),s="current-player-character"===r?u?"1":"2":u?"2":"1";c.setAttribute("data-player",s),c.setAttribute("data-character",a||"boba");var d=document.createElement("div");d.className="boba-shadow",c.appendChild(d);var m=document.createElement("img");m.className="boba-sprite",m.alt=o,m.src=(0,me.o$)(a||"boba"),c.appendChild(m),e.appendChild(c),this.displayManager.uiUpdater.updateKeyHighlight(t,n,i)}},{key:"createPearlSprite",value:function(e,t,n){logger.debug("ðŸ’Ž Adding Pearl sprite at (".concat(t,", ").concat(n,")"));var r=document.createElement("div");r.className="pearl",r.setAttribute("data-type","pearl");var o=document.createElement("div");o.className="pearl-shadow",r.appendChild(o);var a=document.createElement("img");a.className="pearl-sprite",a.src="/static/sprites/character/pearl.png",a.alt="Pearl",r.appendChild(a),e.appendChild(r),this.displayManager.uiUpdater.updateKeyHighlight(t,n,"3")}},{key:"clearPositionSprite",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"all";if(e){var n=document.getElementById("multiplayer-game-map");if(n){var r=n.querySelector('[data-row="'.concat(e.row,'"][data-col="').concat(e.col,'"]'));r&&("all"===t?(r.querySelectorAll(".boba-character, .pearl").forEach(function(e){return e.remove()}),r.setAttribute("data-map","0")):"player1"===t?(r.querySelectorAll('.boba-character[data-player="1"]').forEach(function(e){return e.remove()}),logger.debug("ðŸ§¹ Removed Player 1 sprite")):"player2"===t?(r.querySelectorAll('.boba-character[data-player="2"]').forEach(function(e){return e.remove()}),logger.debug("ðŸ§¹ Removed Player 2 sprite")):"pearl"===t&&(r.querySelectorAll(".pearl").forEach(function(e){return e.remove()}),logger.debug("ðŸ§¹ Removed Pearl sprite")),this.updateMapValueBasedOnSprites(r))}}}},{key:"updateMapValueBasedOnSprites",value:function(e){var t=e.querySelector('.boba-character[data-player="1"]'),n=e.querySelector('.boba-character[data-player="2"]'),r=e.querySelector(".pearl");e.querySelector(".current-player-character")?e.setAttribute("data-map","1"):t||n?e.setAttribute("data-map","2"):r?e.setAttribute("data-map","3"):e.setAttribute("data-map","0")}}],t&&Se(e.prototype,t),n&&Se(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}(),Ce=!1;function Me(e){if(Ce){var t=e.querySelector(".key-top");t&&" "===e.getAttribute("data-letter")&&(t.style.setProperty("--space-background","linear-gradient(145deg, #868e96, #6c757d)"),t.style.setProperty("--space-border","#495057"),t.style.setProperty("--space-shadow","\n    0 6px 0 #343a40,\n    0 8px 12px rgba(0, 0, 0, 0.4),\n    inset 0 2px 0 rgba(255, 255, 255, 0.3),\n    inset 0 -2px 0 rgba(0, 0, 0, 0.2)\n  "))}}function ke(e){return ke="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ke(e)}function Oe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,Ge(r.key),r)}}function Ge(e){var t=function(e,t){if("object"!=ke(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=ke(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==ke(t)?t:t+""}var Te=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.displayManager=t,this.game=t.game},(t=[{key:"updateScoresAndDebug",value:function(){var e,t;if(this.game.clientGameState){var n=document.getElementById("player1-score"),r=document.getElementById("player2-score");n&&(n.textContent=(null===(e=this.game.clientGameState.player1)||void 0===e?void 0:e.score)||0),r&&(r.textContent=(null===(t=this.game.clientGameState.player2)||void 0===t?void 0:t.score)||0);var o=document.getElementById("debug-last-update");o&&(o.textContent=(new Date).toLocaleTimeString())}}},{key:"updateDebugInfo",value:function(){var e,t=document.getElementById("debug-game-id");t&&(t.textContent=this.game.gameId||"Loading...");var n=document.getElementById("current-map-name");if(n&&null!==(e=this.game.clientGameState)&&void 0!==e&&e.map&&(n.textContent=this.game.clientGameState.map.name||"Unknown"),this.game.clientGameState){var r,o,a=document.getElementById("debug-player1-pos"),i=document.getElementById("debug-player2-pos"),l=document.getElementById("debug-pearl-pos");a&&null!==(r=this.game.clientGameState.player1)&&void 0!==r&&r.position&&(a.textContent="(".concat(this.game.clientGameState.player1.position.row,", ").concat(this.game.clientGameState.player1.position.col,")")),i&&null!==(o=this.game.clientGameState.player2)&&void 0!==o&&o.position&&(i.textContent="(".concat(this.game.clientGameState.player2.position.row,", ").concat(this.game.clientGameState.player2.position.col,")")),l&&this.game.clientGameState.pearl_position&&(l.textContent="(".concat(this.game.clientGameState.pearl_position.row,", ").concat(this.game.clientGameState.pearl_position.col,")"))}var c=document.getElementById("debug-websocket");c&&(c.textContent=this.game.websocket?"Connected":"Disconnected");var u=document.getElementById("debug-last-update");u&&(u.textContent=(new Date).toLocaleTimeString())}},{key:"updateKeyHighlight",value:function(e,t,n){var r=document.getElementById("multiplayer-game-map");if(r){var o=r.querySelector('[data-row="'.concat(e,'"][data-col="').concat(t,'"]'));o?(o.setAttribute("data-map",n),Me(o)):logger.warn("Could not find key element for highlight at (".concat(e,", ").concat(t,")"))}}},{key:"updatePlayerAvatars",value:function(){var e,t;if(null!==(e=this.game.clientGameState.player1)&&void 0!==e&&e.character){var n=document.getElementById("player1-character");n&&(n.src=(0,me.o$)(this.game.clientGameState.player1.character))}if(null!==(t=this.game.clientGameState.player2)&&void 0!==t&&t.character){var r=document.getElementById("player2-character");r&&(r.src=(0,me.o$)(this.game.clientGameState.player2.character))}}},{key:"updatePlayerNames",value:function(){var e,t;document.getElementById("player1-username").textContent=(null===(e=this.game.clientGameState.player1)||void 0===e?void 0:e.username)||"Player 1",document.getElementById("player2-username").textContent=(null===(t=this.game.clientGameState.player2)||void 0===t?void 0:t.username)||"Player 2"}},{key:"updateScores",value:function(){var e,t;document.getElementById("player1-score").textContent=(null===(e=this.game.clientGameState.player1)||void 0===e?void 0:e.score)||0,document.getElementById("player2-score").textContent=(null===(t=this.game.clientGameState.player2)||void 0===t?void 0:t.score)||0}}])&&Oe(e.prototype,t),n&&Oe(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}();function Ie(e){return Ie="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ie(e)}function Ne(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,Ae(r.key),r)}}function Ae(e){var t=function(e,t){if("object"!=Ie(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=Ie(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==Ie(t)?t:t+""}var je=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.displayManager=t,this.game=t.game},(t=[{key:"positionsEqual",value:function(e,t){if(!e||!t)return logger.debug("ðŸ” positionsEqual: one position is null/undefined",JSON.stringify(e),JSON.stringify(t)),!1;var n=e.row===t.row&&e.col===t.col;return n||logger.debug("ðŸ” positionsEqual: positions differ",JSON.stringify(e),"vs",JSON.stringify(t)),n}},{key:"throttledDisplayUpdate",value:function(){var e=this,t=Date.now();if(t-this.displayManager.lastDisplayUpdate>=this.displayManager.displayUpdateThrottle)this.displayManager.lastDisplayUpdate=t,this.displayManager.updateGameDisplayOptimized(),this.displayManager.pendingDisplayUpdate=!1;else if(!this.displayManager.pendingDisplayUpdate){this.displayManager.pendingDisplayUpdate=!0;var n=this.displayManager.displayUpdateThrottle-(t-this.displayManager.lastDisplayUpdate);setTimeout(function(){e.displayManager.pendingDisplayUpdate&&(e.displayManager.lastDisplayUpdate=Date.now(),e.displayManager.updateGameDisplayOptimized(),e.displayManager.pendingDisplayUpdate=!1)},n)}}},{key:"clearAllStaticHighlights",value:function(){var e=document.getElementById("multiplayer-game-map");if(e){var t=e.querySelectorAll(".boba-character, .pearl");t.forEach(function(e){return e.remove()}),logger.debug("ðŸ’€ Removed ".concat(t.length," dead sprites from initial render"));var n=e.querySelectorAll("[data-map]"),r=0;n.forEach(function(e){var t=e.getAttribute("data-map");t&&"0"!==t&&(e.setAttribute("data-map","0"),r++)}),logger.debug("ðŸ§¹ Cleared ".concat(r," static key highlights"))}}}])&&Ne(e.prototype,t),n&&Ne(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}();function _e(e){return _e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_e(e)}function Re(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,De(r.key),r)}}function De(e){var t=function(e,t){if("object"!=_e(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=_e(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==_e(t)?t:t+""}var xe=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.displayManager=t,this.game=t.game},(t=[{key:"showError",value:function(e){document.getElementById("multiplayer-loading").style.display="none",document.getElementById("multiplayer-game-content").style.display="none",document.getElementById("multiplayer-error").style.display="flex",document.getElementById("error-message").textContent=e,this.game.updateConnectionStatus("disconnected","Error")}},{key:"hideLoading",value:function(){var e=document.getElementById("multiplayer-loading");e?(e.style.display="none",logger.debug("Loading screen hidden")):logger.error("Loading element not found")}},{key:"showGameContent",value:function(){var e=document.getElementById("multiplayer-game-content");e?(e.style.display="block",logger.debug("Game content shown")):logger.error("Game content element not found")}}])&&Re(e.prototype,t),n&&Re(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}();function Le(e){return Le="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Le(e)}function Be(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,He(r.key),r)}}function He(e){var t=function(e,t){if("object"!=Le(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=Le(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==Le(t)?t:t+""}var Fe=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.lastDisplayUpdate=0,this.displayUpdateThrottle=16,this.pendingDisplayUpdate=!1,this.needsInitialCleanup=!0,this.lastForceUpdate=0,this.gameMapRenderer=new be(this),this.spriteManager=new Ee(this),this.uiUpdater=new Te(this),this.displayUtils=new je(this),this.screenManager=new xe(this)},(t=[{key:"updateGameDisplay",value:function(){var e,t;this.game.clientGameState?(logger.debug("ðŸŽ¨ UPDATING GAME DISPLAY:",{player1:JSON.stringify(null===(e=this.game.clientGameState.player1)||void 0===e?void 0:e.position),player2:JSON.stringify(null===(t=this.game.clientGameState.player2)||void 0===t?void 0:t.position),pearl:JSON.stringify(this.game.clientGameState.pearl_position)}),this.uiUpdater.updateScores(),this.uiUpdater.updatePlayerNames(),this.uiUpdater.updatePlayerAvatars(),this.gameMapRenderer.updateClientGameMap(),this.gameMapRenderer.updateGameMapOptimized(),this.uiUpdater.updateDebugInfo(),this.game.gameStateManager.updateClientGameStateForPrediction()):logger.error("âŒ Cannot update display - no client game state")}},{key:"updateGameDisplayOptimized",value:function(){this.game.clientGameState?(this.uiUpdater.updateScoresAndDebug(),this.gameMapRenderer.updateGameMapOptimized(),this.game.gameStateManager.updateClientGameStateForPrediction()):logger.error("âŒ Cannot update display - no client game state")}},{key:"updateClientGameMap",value:function(){this.gameMapRenderer.updateClientGameMap()}},{key:"updateGameMapOptimized",value:function(){this.gameMapRenderer.updateGameMapOptimized()}},{key:"throttledDisplayUpdate",value:function(){this.displayUtils.throttledDisplayUpdate()}},{key:"showError",value:function(e){this.screenManager.showError(e)}},{key:"hideLoading",value:function(){this.screenManager.hideLoading()}},{key:"showGameContent",value:function(){this.screenManager.showGameContent()}}])&&Be(e.prototype,t),n&&Be(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}();function Ue(e){return Ue="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ue(e)}function ze(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function a(n,r,o,a){var c=r&&r.prototype instanceof l?r:l,u=Object.create(c.prototype);return We(u,"_invoke",function(n,r,o){var a,l,c,u=0,s=o||[],d=!1,m={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,n){return a=t,l=0,c=e,m.n=n,i}};function p(n,r){for(l=n,c=r,t=0;!d&&u&&!o&&t<s.length;t++){var o,a=s[t],p=m.p,g=a[2];n>3?(o=g===r)&&(c=a[(l=a[4])?5:(l=3,3)],a[4]=a[5]=e):a[0]<=p&&((o=n<2&&p<a[1])?(l=0,m.v=r,m.n=a[1]):p<g&&(o=n<3||a[0]>r||r>g)&&(a[4]=n,a[5]=r,m.n=g,l=0))}if(o||n>1)return i;throw d=!0,r}return function(o,s,g){if(u>1)throw TypeError("Generator is already running");for(d&&1===s&&p(s,g),l=s,c=g;(t=l<2?e:c)||!d;){a||(l?l<3?(l>1&&(m.n=-1),p(l,c)):m.n=c:m.v=c);try{if(u=2,a){if(l||(o="next"),t=a[o]){if(!(t=t.call(a,c)))throw TypeError("iterator result is not an object");if(!t.done)return t;c=t.value,l<2&&(l=0)}else 1===l&&(t=a.return)&&t.call(a),l<2&&(c=TypeError("The iterator does not provide a '"+o+"' method"),l=1);a=e}else if((t=(d=m.n<0)?c:n.call(r,m))!==i)break}catch(t){a=e,l=1,c=t}finally{u=1}}return{value:t,done:d}}}(n,o,a),!0),u}var i={};function l(){}function c(){}function u(){}t=Object.getPrototypeOf;var s=[][r]?t(t([][r]())):(We(t={},r,function(){return this}),t),d=u.prototype=l.prototype=Object.create(s);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,We(e,o,"GeneratorFunction")),e.prototype=Object.create(d),e}return c.prototype=u,We(d,"constructor",u),We(u,"constructor",c),c.displayName="GeneratorFunction",We(u,o,"GeneratorFunction"),We(d),We(d,o,"Generator"),We(d,r,function(){return this}),We(d,"toString",function(){return"[object Generator]"}),(ze=function(){return{w:a,m}})()}function We(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}We=function(e,t,n,r){function a(t,n){We(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},We(e,t,n,r)}function qe(e,t,n,r,o,a,i){try{var l=e[a](i),c=l.value}catch(e){return void n(e)}l.done?t(c):Promise.resolve(c).then(r,o)}function Ve(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,Ye(r.key),r)}}function Ye(e){var t=function(e,t){if("object"!=Ue(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=Ue(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==Ue(t)?t:t+""}var Je=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.websocketManager=t,this.game=t.game,this.websocket=null},t=[{key:"setupWebSocket",value:function(){var e=this;if(this.game.gameId&&this.game.playerId){var t="https:"===window.location.protocol?"wss:":"ws:",n="".concat(t,"//").concat(window.location.host,"/ws/multiplayer/").concat(this.game.gameId);logger.debug("Connecting to WebSocket:",n),this.websocket=new WebSocket(n),this.game.websocket=this.websocket,this.websocketManager.websocket=this.websocket,this.websocket.onopen=function(){logger.debug("ðŸ”— WebSocket connected"),e.websocketManager.reconnectionManager.resetReconnectAttempts(),e.game.updateConnectionStatus("connected","Connected (Live)");var t={type:"request_countdown_status",player_id:e.game.playerId,game_id:e.game.gameId};logger.debug("ðŸŽ¯ Requesting countdown status:",t),e.websocket.send(JSON.stringify(t)),logger.debug("âœ… Countdown request sent")},this.websocket.onmessage=function(t){try{var n=JSON.parse(t.data);e.websocketManager.messageHandler.handleWebSocketMessage(n)}catch(e){logger.error("Error parsing WebSocket message:",e)}},this.websocket.onclose=function(t){logger.debug("WebSocket disconnected:",t.code,t.reason),e.websocket=null,e.game.websocket=null,e.websocketManager.websocket=null,e.game.updateConnectionStatus("disconnected","Disconnected"),1e3!==t.code&&e.websocketManager.reconnectionManager.attemptReconnection()},this.websocket.onerror=function(t){logger.error("WebSocket error:",t),e.game.updateConnectionStatus("disconnected","Connection Error")}}else logger.error("Cannot setup WebSocket without gameId and playerId")}},{key:"disconnect",value:(r=ze().m(function e(){var t;return ze().w(function(e){for(;;)switch(e.p=e.n){case 0:if(this.websocket&&(this.websocket.close(1e3,"User disconnected"),this.websocket=null,this.game.websocket=null,this.websocketManager.websocket=null),!this.game.playerId){e.n=4;break}return e.p=1,e.n=2,fetch("/api/multiplayer/disconnect",{method:"POST",headers:{"Content-Type":"application/json"}});case 2:e.n=4;break;case 3:e.p=3,t=e.v,logger.warn("Error disconnecting:",t);case 4:return e.a(2)}},e,this,[[1,3]])}),o=function(){var e=this,t=arguments;return new Promise(function(n,o){var a=r.apply(e,t);function i(e){qe(a,n,o,i,l,"next",e)}function l(e){qe(a,n,o,i,l,"throw",e)}i(void 0)})},function(){return o.apply(this,arguments)})}],t&&Ve(e.prototype,t),n&&Ve(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,r,o}();function Ke(e){return Ke="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ke(e)}function $e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function Xe(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?$e(Object(n),!0).forEach(function(t){Qe(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):$e(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function Qe(e,t,n){return(t=et(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ze(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,et(r.key),r)}}function et(e){var t=function(e,t){if("object"!=Ke(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=Ke(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==Ke(t)?t:t+""}var tt=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.websocketManager=t,this.game=t.game},(t=[{key:"handleWebSocketMessage",value:function(e){switch(logger.debug("ðŸ”¥ WEBSOCKET MESSAGE RECEIVED:",e.type,e),e.type){case"game_update":logger.debug("ðŸŽ® Processing game update..."),this.handleGameUpdate(e.data);break;case"game_complete":logger.debug("ðŸ† Game completed"),this.game.gameCompletionHandler.handleGameCompletion(e.data);break;case"player_disconnected":logger.debug("ðŸ‘‹ Player disconnected"),this.handlePlayerDisconnected(e.data);break;case"game_expired":logger.debug("â° Game expired"),this.handleGameExpired(e.data);break;case"countdown":logger.debug("â° Countdown message received:",e.data),this.handleCountdown(e.data);break;default:logger.warn("â“ Unknown WebSocket message type:",e.type)}}},{key:"handleGameUpdate",value:function(e){var t,n,r,o,a,i,l,c;if(logger.debug("ðŸ”„ HANDLING GAME UPDATE:",e),logger.debug("ðŸŽ¯ Current player ID:",this.game.playerId),logger.debug("ðŸ“Š Pending moves:",this.game.movementProcessor.pendingMoves.length),logger.debug("ðŸŽ­ CHARACTER DEBUG - Current character data in handleGameUpdate:",{player1Character:null===(t=this.game.gameState)||void 0===t||null===(t=t.player1)||void 0===t?void 0:t.character,player2Character:null===(n=this.game.gameState)||void 0===n||null===(n=n.player2)||void 0===n?void 0:n.character,player1ID:null===(r=this.game.gameState)||void 0===r||null===(r=r.player1)||void 0===r?void 0:r.id,player2ID:null===(o=this.game.gameState)||void 0===o||null===(o=o.player2)||void 0===o?void 0:o.id}),logger.debug("ðŸŽ­ CHARACTER DEBUG - Client character data in handleGameUpdate:",{player1Character:null===(a=this.game.clientGameState)||void 0===a||null===(a=a.player1)||void 0===a?void 0:a.character,player2Character:null===(i=this.game.clientGameState)||void 0===i||null===(i=i.player2)||void 0===i?void 0:i.character,player1ID:null===(l=this.game.clientGameState)||void 0===l||null===(l=l.player1)||void 0===l?void 0:l.id,player2ID:null===(c=this.game.clientGameState)||void 0===c||null===(c=c.player2)||void 0===c?void 0:c.id}),this.game.gameState){var u=!this.positionsEqual(this.game.gameState.player1.position,e.player1_position),s=!this.positionsEqual(this.game.gameState.player2.position,e.player2_position),d=!this.positionsEqual(this.game.gameState.pearl_position,e.pearl_position);if(logger.debug("ðŸ” DETAILED Position comparison:"),logger.debug("P1 OLD:",JSON.stringify(this.game.gameState.player1.position),"NEW:",JSON.stringify(e.player1_position),"CHANGED:",u),logger.debug("P2 OLD:",JSON.stringify(this.game.gameState.player2.position),"NEW:",JSON.stringify(e.player2_position),"CHANGED:",s),logger.debug("Pearl OLD:",JSON.stringify(this.game.gameState.pearl_position),"NEW:",JSON.stringify(e.pearl_position),"CHANGED:",d),!u&&!s&&!d&&this.game.gameState.player1.score===e.player1_score&&this.game.gameState.player2.score===e.player2_score){logger.debug("â­ï¸ No changes detected, but checking for force update conditions");var m=Date.now();if(this.game.lastForceUpdate&&!(m-this.game.lastForceUpdate>1e4))return void logger.debug("â­ï¸ Skipping update");logger.debug("ðŸ”¥ FORCING UPDATE due to timeout - ensuring opponent visibility"),this.game.lastForceUpdate=m}this.updateGameStateFromServer(e),this.updateClientStateBasedOnPendingMoves(e),this.forceVisualUpdate()}else logger.error("âŒ No game state available")}},{key:"updateGameStateFromServer",value:function(e){var t=this.game.gameState.player1.score,n=this.game.gameState.player2.score;this.game.gameState.player1.position=e.player1_position,this.game.gameState.player1.score=e.player1_score;var r=this.game.gameState.player1.character;this.game.gameState.player2.position=e.player2_position,this.game.gameState.player2.score=e.player2_score;var o=this.game.gameState.player2.character;this.game.gameState.pearl_position=e.pearl_position,this.game.gameState.player1.character=r,this.game.gameState.player2.character=o;var a=this.game.playerId===this.game.gameState.player1.id;(a&&e.player1_score>t||!a&&e.player2_score>n)&&F.R.playPearlCollectedSound(),logger.debug("ðŸ† Updated server state - P1:",e.player1_position,"P2:",e.player2_position)}},{key:"updateClientStateBasedOnPendingMoves",value:function(e){var t=this,n=this.game.playerId===this.game.gameState.player1.id;if(logger.debug("ðŸŽ² Player identification:",{currentPlayerID:this.game.playerId,player1ID:this.game.gameState.player1.id,player2ID:this.game.gameState.player2.id,isPlayer1:n}),0===this.game.movementProcessor.pendingMoves.length)logger.debug("âœ… No pending moves - updating everything"),this.game.clientGameState=this.game.gameStateManager.cloneGameState(this.game.gameState),logger.debug("ðŸ”§ FIXING COLOR CODING after server update"),this.game.displayManager.updateClientGameMap(),this.game.displayManager.updateGameDisplay();else{logger.debug("â³ Has pending moves - selective update");var r=this.game.clientGameState.player1.score,o=this.game.clientGameState.player2.score;if(n){logger.debug("ðŸŽ¯ Updating opponent (P2) position from",JSON.stringify(this.game.clientGameState.player2.position),"to",JSON.stringify(e.player2_position));var a=this.game.clientGameState.player2.character;this.game.clientGameState.player2.position=e.player2_position,this.game.clientGameState.player2.score=e.player2_score,this.game.clientGameState.player2.character=a,this.game.clientGameState.player1.score=e.player1_score,e.player1_score>r&&F.R.playPearlCollectedSound(),logger.debug("âœ… P2 position updated with character preserved:",a)}else{logger.debug("ðŸŽ¯ Updating opponent (P1) position from",JSON.stringify(this.game.clientGameState.player1.position),"to",JSON.stringify(e.player1_position));var i=this.game.clientGameState.player1.character;this.game.clientGameState.player1.position=e.player1_position,this.game.clientGameState.player1.score=e.player1_score,this.game.clientGameState.player2.score=e.player2_score,e.player2_score>o&&F.R.playPearlCollectedSound(),this.game.clientGameState.player1.character=i,logger.debug("âœ… P1 position updated with character preserved:",i),this.game.clientGameState.player2.score=e.player2_score}this.game.clientGameState.pearl_position=e.pearl_position,logger.debug("ðŸ’Ž Updated pearl position:",e.pearl_position),this.game.displayManager.uiUpdater.updateScoresAndDebug(),logger.debug("ðŸ“Š Updated scores and debug info"),logger.debug("ðŸ”§ APPLYING COLOR CODING before forced visual update"),this.game.displayManager.updateClientGameMap(),logger.debug("ðŸŽ¯ FORCING VISUAL UPDATE FOR OPPONENT MOVEMENT"),requestAnimationFrame(function(){logger.debug("ðŸš€ FORCING OPTIMIZED UPDATE FOR OPPONENT MOVEMENT"),t.game.displayManager.updateClientGameMap(),t.game.displayManager.updateGameMapOptimized(),logger.debug("âœ… Optimized update completed via requestAnimationFrame")})}}},{key:"forceVisualUpdate",value:function(){var e,t,n,r;logger.debug("ðŸ”„ FORCING DOM REFLOW AND REPAINT");var o=document.getElementById("multiplayer-game-map");if(o){var a=o.offsetHeight,i=o.offsetWidth;logger.debug("ðŸ“ Map dimensions (forcing reflow):",i,"x",a),o.style.transform="translateZ(0)",o.offsetHeight,o.style.transform="";var l=o.querySelectorAll(".boba-character, .pearl");l.forEach(function(e){e.style.visibility="visible",e.style.opacity="1"}),logger.debug("ðŸŽ¨ Found and ensured visibility of",l.length,"sprites")}logger.debug("ðŸŽ­ CHARACTER DEBUG - Final character data after handleGameUpdate:",{gameStateP1Character:null===(e=this.game.gameState)||void 0===e||null===(e=e.player1)||void 0===e?void 0:e.character,gameStateP2Character:null===(t=this.game.gameState)||void 0===t||null===(t=t.player2)||void 0===t?void 0:t.character,clientStateP1Character:null===(n=this.game.clientGameState)||void 0===n||null===(n=n.player1)||void 0===n?void 0:n.character,clientStateP2Character:null===(r=this.game.clientGameState)||void 0===r||null===(r=r.player2)||void 0===r?void 0:r.character})}},{key:"positionsEqual",value:function(e,t){if(!e||!t)return logger.debug("ðŸ” positionsEqual: one position is null/undefined",JSON.stringify(e),JSON.stringify(t)),!1;var n=e.row===t.row&&e.col===t.col;return n||logger.debug("ðŸ” positionsEqual: positions differ",JSON.stringify(e),"vs",JSON.stringify(t)),n}},{key:"handlePlayerDisconnected",value:function(e){logger.debug("ðŸ‘‹ PLAYER DISCONNECTED:",e),this.game.isConnected=!1,this.websocketManager.websocket&&(this.websocketManager.websocket.close(),this.websocketManager.websocket=null,this.game.websocket=null),this.game.gameCompletionHandler.handlePlayerDisconnection(Xe({reason:"Your opponent has left the game",message:"You win by default!"},e))}},{key:"handleGameExpired",value:function(e){logger.debug("â° GAME EXPIRED:",e),this.game.isConnected=!1,this.websocketManager.websocket&&(this.websocketManager.websocket.close(),this.websocketManager.websocket=null,this.game.websocket=null),this.game.gameCompletionHandler.handleGameTimeout(Xe({reason:"Game timed out (8 minutes)",message:"Time limit exceeded"},e))}},{key:"handleCountdown",value:function(e){var t=this;logger.debug("â° COUNTDOWN:",e),this.game.countdownActive=e.active,e.active?this.showCountdownDisplay(e.value):(this.showCountdownDisplay(e.value),setTimeout(function(){t.hideCountdownDisplay(),t.game.countdownActive=!1},1e3))}},{key:"showCountdownDisplay",value:function(e){logger.debug("ðŸŽ¯ showCountdownDisplay called with:",e);var t=document.getElementById("multiplayer-countdown");if(!t){logger.debug("ðŸ“ Creating new countdown element"),(t=document.createElement("div")).id="multiplayer-countdown",t.style.cssText="\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        font-size: 4rem;\n        font-weight: bold;\n        text-align: center;\n        color: #27ae60;\n        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);\n        z-index: 1000;\n        background: rgba(0, 0, 0, 0.8);\n        padding: 20px 40px;\n        border-radius: 15px;\n        animation: countdownPulse 1s ease-in-out;\n      ";var n=document.getElementById("multiplayer-game-map");n||(n=document.getElementById("game-map")),n||(n=document.querySelector(".multiplayer-game-board")),n||(n=document.querySelector(".game-board")),n||(n=document.body),logger.debug("ðŸ“ Adding countdown to container:",n),n.appendChild(t)}t.textContent=e,t.style.animation="none",t.offsetHeight,t.style.animation="countdownPulse 1s ease-in-out",t.style.color="GO"===e?"#f39c12":"#27ae60"}},{key:"hideCountdownDisplay",value:function(){var e=document.getElementById("multiplayer-countdown");e&&e.remove()}}])&&Ze(e.prototype,t),n&&Ze(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}();function nt(e){return nt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},nt(e)}function rt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,ot(r.key),r)}}function ot(e){var t=function(e,t){if("object"!=nt(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=nt(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==nt(t)?t:t+""}var at=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.websocketManager=t,this.game=t.game,this.wsReconnectAttempts=0,this.maxWsReconnectAttempts=5,this.wsReconnectDelay=1e3},(t=[{key:"attemptReconnection",value:function(){var e=this;this.wsReconnectAttempts<this.maxWsReconnectAttempts&&(this.wsReconnectAttempts++,logger.debug("Attempting WebSocket reconnection ".concat(this.wsReconnectAttempts,"/").concat(this.maxWsReconnectAttempts)),setTimeout(function(){return e.websocketManager.connectionManager.setupWebSocket()},this.wsReconnectDelay*this.wsReconnectAttempts))}},{key:"resetReconnectAttempts",value:function(){this.wsReconnectAttempts=0}}])&&rt(e.prototype,t),n&&rt(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}();function it(e){return it="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},it(e)}function lt(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function a(n,r,o,a){var c=r&&r.prototype instanceof l?r:l,u=Object.create(c.prototype);return ct(u,"_invoke",function(n,r,o){var a,l,c,u=0,s=o||[],d=!1,m={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,n){return a=t,l=0,c=e,m.n=n,i}};function p(n,r){for(l=n,c=r,t=0;!d&&u&&!o&&t<s.length;t++){var o,a=s[t],p=m.p,g=a[2];n>3?(o=g===r)&&(c=a[(l=a[4])?5:(l=3,3)],a[4]=a[5]=e):a[0]<=p&&((o=n<2&&p<a[1])?(l=0,m.v=r,m.n=a[1]):p<g&&(o=n<3||a[0]>r||r>g)&&(a[4]=n,a[5]=r,m.n=g,l=0))}if(o||n>1)return i;throw d=!0,r}return function(o,s,g){if(u>1)throw TypeError("Generator is already running");for(d&&1===s&&p(s,g),l=s,c=g;(t=l<2?e:c)||!d;){a||(l?l<3?(l>1&&(m.n=-1),p(l,c)):m.n=c:m.v=c);try{if(u=2,a){if(l||(o="next"),t=a[o]){if(!(t=t.call(a,c)))throw TypeError("iterator result is not an object");if(!t.done)return t;c=t.value,l<2&&(l=0)}else 1===l&&(t=a.return)&&t.call(a),l<2&&(c=TypeError("The iterator does not provide a '"+o+"' method"),l=1);a=e}else if((t=(d=m.n<0)?c:n.call(r,m))!==i)break}catch(t){a=e,l=1,c=t}finally{u=1}}return{value:t,done:d}}}(n,o,a),!0),u}var i={};function l(){}function c(){}function u(){}t=Object.getPrototypeOf;var s=[][r]?t(t([][r]())):(ct(t={},r,function(){return this}),t),d=u.prototype=l.prototype=Object.create(s);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,ct(e,o,"GeneratorFunction")),e.prototype=Object.create(d),e}return c.prototype=u,ct(d,"constructor",u),ct(u,"constructor",c),c.displayName="GeneratorFunction",ct(u,o,"GeneratorFunction"),ct(d),ct(d,o,"Generator"),ct(d,r,function(){return this}),ct(d,"toString",function(){return"[object Generator]"}),(lt=function(){return{w:a,m}})()}function ct(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}ct=function(e,t,n,r){function a(t,n){ct(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},ct(e,t,n,r)}function ut(e,t,n,r,o,a,i){try{var l=e[a](i),c=l.value}catch(e){return void n(e)}l.done?t(c):Promise.resolve(c).then(r,o)}function st(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,dt(r.key),r)}}function dt(e){var t=function(e,t){if("object"!=it(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=it(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==it(t)?t:t+""}var mt=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.websocket=null,this.connectionManager=new Je(this),this.messageHandler=new tt(this),this.reconnectionManager=new at(this)},t=[{key:"setupWebSocket",value:function(){this.connectionManager.setupWebSocket()}},{key:"disconnect",value:(r=lt().m(function e(){return lt().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,this.connectionManager.disconnect();case 1:return e.a(2)}},e,this)}),o=function(){var e=this,t=arguments;return new Promise(function(n,o){var a=r.apply(e,t);function i(e){ut(a,n,o,i,l,"next",e)}function l(e){ut(a,n,o,i,l,"throw",e)}i(void 0)})},function(){return o.apply(this,arguments)})}],t&&st(e.prototype,t),n&&st(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,r,o}(),pt=n(597),gt=n(630),ft=0,yt=!1,ht=[],vt=[{selector:"#viewLeaderboard",column:1,row:0,type:"button"},{selector:"#backToMenu",column:1,row:1,type:"button"}];function bt(){logger.debug("Initializing multiplayer completion vim navigation..."),St(),ft=Pt(),yt=!0,logger.debug("Multiplayer completion vim starting at element index: ".concat(ft)),Mt(),document.addEventListener("keydown",Ct),logger.debug("Multiplayer completion vim navigation initialized")}function wt(){yt=!1,kt(),document.removeEventListener("keydown",Ct),logger.debug("Multiplayer completion vim navigation disabled")}function St(){ht=[],vt.forEach(function(e){var t=document.querySelector(e.selector);t&&function(e){if(!e)return!1;try{var t=window.getComputedStyle(e),n=e.getBoundingClientRect();return"none"!==t.display&&"hidden"!==t.visibility&&"0"!==t.opacity&&n.width>0&&n.height>0&&!e.hasAttribute("disabled")&&!e.classList.contains("hidden")}catch(e){return!1}}(t)&&ht.push(e)}),logger.debug("Available multiplayer completion elements:",ht.length)}function Pt(){for(var e=0;e<ht.length;e++)if("#backToMenu"===ht[e].selector)return e;return Math.max(0,ht.length-1)}function Et(){if(ft<0||ft>=ht.length)return null;var e=ht[ft];if(!e)return null;try{return document.querySelector(e.selector)}catch(e){return null}}function Ct(e){var t;if(yt&&(document.getElementById("completionModal")&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&!e.target.isContentEditable))switch(e.key.toLowerCase()){case"h":case"l":e.preventDefault();break;case"j":e.preventDefault(),function(){var e=ht[ft];if(!e)return;if("#viewLeaderboard"===e.selector){var t=ht.findIndex(function(e){return"#backToMenu"===e.selector});if(t>=0)ft=t,Mt()}else if("#backToMenu"===e.selector){var n=ht.findIndex(function(e){return"#viewLeaderboard"===e.selector});if(n>=0)ft=n,Mt()}}();break;case"k":e.preventDefault(),function(){var e=ht[ft];if(!e)return;if("#backToMenu"===e.selector){var t=ht.findIndex(function(e){return"#viewLeaderboard"===e.selector});if(t>=0)ft=t,Mt()}else if("#viewLeaderboard"===e.selector){var n=ht.findIndex(function(e){return"#backToMenu"===e.selector});if(n>=0)ft=n,Mt()}}();break;case"enter":e.preventDefault(),function(){var e=Et();if(logger.debug("Multiplayer completion activating element:",e),!e)return void logger.debug("No element to activate in multiplayer completion");try{e.click()}catch(e){logger.debug("Error clicking multiplayer completion element:",e)}}();break;case"escape":e.preventDefault(),(t=document.querySelector("#backToMenu"))&&t.click()}}function Mt(){logger.debug("Multiplayer completion updateCursor called"),kt();var e=Et();logger.debug("Multiplayer completion current element for cursor:",e),e?function(e){if(!e)return;var t=document.createElement("div");t.className="multiplayer-completion-vim-cursor",t.textContent="ðŸ§‹",t.style.cssText="\n    position: fixed;\n    font-size: 20px;\n    z-index: 99999;\n    pointer-events: none;\n    animation: multiplayer-completion-vim-cursor-pulse 1s ease-in-out infinite alternate;\n    filter: drop-shadow(0 0 12px rgba(255, 255, 255, 1)) drop-shadow(0 0 8px rgba(0, 0, 0, 1));\n    background: rgba(255, 165, 0, 0.8);\n    border: 2px solid white;\n    border-radius: 50%;\n    width: 35px;\n    height: 35px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    box-shadow: 0 0 15px rgba(255, 165, 0, 0.8);\n  ";var n=e.getBoundingClientRect();if(t.style.top=n.top-10+"px",t.style.left=n.left-10+"px",document.body.appendChild(t),!document.getElementById("multiplayer-completion-vim-cursor-styles")){var r=document.createElement("style");r.id="multiplayer-completion-vim-cursor-styles",r.textContent="\n      @keyframes multiplayer-completion-vim-cursor-pulse {\n        0% { \n          transform: scale(1) rotate(-5deg); \n          opacity: 0.9; \n        }\n        100% { \n          transform: scale(1.15) rotate(5deg); \n          opacity: 1; \n        }\n      }\n    ",document.head.appendChild(r)}}(e):logger.debug("No element found for multiplayer completion cursor")}function kt(){document.querySelectorAll(".multiplayer-completion-vim-cursor").forEach(function(e){e.remove()}),document.querySelectorAll("[data-original-multiplayer-completion-text]").forEach(function(e){e.textContent=e.getAttribute("data-original-multiplayer-completion-text"),e.removeAttribute("data-original-multiplayer-completion-text")})}function Ot(e){return Ot="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ot(e)}function Gt(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function a(n,r,o,a){var c=r&&r.prototype instanceof l?r:l,u=Object.create(c.prototype);return Tt(u,"_invoke",function(n,r,o){var a,l,c,u=0,s=o||[],d=!1,m={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,n){return a=t,l=0,c=e,m.n=n,i}};function p(n,r){for(l=n,c=r,t=0;!d&&u&&!o&&t<s.length;t++){var o,a=s[t],p=m.p,g=a[2];n>3?(o=g===r)&&(c=a[(l=a[4])?5:(l=3,3)],a[4]=a[5]=e):a[0]<=p&&((o=n<2&&p<a[1])?(l=0,m.v=r,m.n=a[1]):p<g&&(o=n<3||a[0]>r||r>g)&&(a[4]=n,a[5]=r,m.n=g,l=0))}if(o||n>1)return i;throw d=!0,r}return function(o,s,g){if(u>1)throw TypeError("Generator is already running");for(d&&1===s&&p(s,g),l=s,c=g;(t=l<2?e:c)||!d;){a||(l?l<3?(l>1&&(m.n=-1),p(l,c)):m.n=c:m.v=c);try{if(u=2,a){if(l||(o="next"),t=a[o]){if(!(t=t.call(a,c)))throw TypeError("iterator result is not an object");if(!t.done)return t;c=t.value,l<2&&(l=0)}else 1===l&&(t=a.return)&&t.call(a),l<2&&(c=TypeError("The iterator does not provide a '"+o+"' method"),l=1);a=e}else if((t=(d=m.n<0)?c:n.call(r,m))!==i)break}catch(t){a=e,l=1,c=t}finally{u=1}}return{value:t,done:d}}}(n,o,a),!0),u}var i={};function l(){}function c(){}function u(){}t=Object.getPrototypeOf;var s=[][r]?t(t([][r]())):(Tt(t={},r,function(){return this}),t),d=u.prototype=l.prototype=Object.create(s);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,Tt(e,o,"GeneratorFunction")),e.prototype=Object.create(d),e}return c.prototype=u,Tt(d,"constructor",u),Tt(u,"constructor",c),c.displayName="GeneratorFunction",Tt(u,o,"GeneratorFunction"),Tt(d),Tt(d,o,"Generator"),Tt(d,r,function(){return this}),Tt(d,"toString",function(){return"[object Generator]"}),(Gt=function(){return{w:a,m}})()}function Tt(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}Tt=function(e,t,n,r){function a(t,n){Tt(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},Tt(e,t,n,r)}function It(e,t,n,r,o,a,i){try{var l=e[a](i),c=l.value}catch(e){return void n(e)}l.done?t(c):Promise.resolve(c).then(r,o)}function Nt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,At(r.key),r)}}function At(e){var t=function(e,t){if("object"!=Ot(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=Ot(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==Ot(t)?t:t+""}var jt=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t},t=[{key:"handleGameCompletion",value:function(e){logger.debug("ðŸ† MULTIPLAYER GAME COMPLETION:",e),F.R.playGameCompleteSound(),this.game.isConnected=!1,this.game.websocket&&(this.game.websocket.close(),this.game.websocket=null),this.showUnifiedCompletionModal(e)}},{key:"handlePlayerDisconnection",value:function(e){var t,n;logger.debug("ðŸ“¡ PLAYER DISCONNECTION:",e),this.game.isConnected=!1,this.game.websocket&&(this.game.websocket.close(),this.game.websocket=null),this.showUnifiedCompletionModal({type:"disconnection",winner:"disconnection",reason:e.reason||"Player disconnected",message:e.message||"Game ended due to disconnection",player1:null===(t=this.game.clientGameState)||void 0===t?void 0:t.player1,player2:null===(n=this.game.clientGameState)||void 0===n?void 0:n.player2,isWinner:!1})}},{key:"handleGameTimeout",value:function(e){var t,n;logger.debug("â° GAME TIMEOUT:",e),F.R.playTimeoutSound(),this.game.isConnected=!1,this.game.websocket&&(this.game.websocket.close(),this.game.websocket=null),this.showUnifiedCompletionModal({type:"timeout",winner:"timeout",reason:"Game timed out (8 minutes)",message:"Time limit exceeded",player1:null===(t=this.game.clientGameState)||void 0===t?void 0:t.player1,player2:null===(n=this.game.clientGameState)||void 0===n?void 0:n.player2,isWinner:!1})}},{key:"showUnifiedCompletionModal",value:function(e){logger.debug("ðŸŽ‰ SHOWING UNIFIED COMPLETION MODAL:",e);var t=document.getElementById(pt.w.ELEMENT_IDS.COMPLETION_MODAL);t&&(t.remove(),logger.debug("Removed existing completion modal"));var n=this.getCompletionInfo(e),r=this.createCompletionModalHTML(n,e);document.body.insertAdjacentHTML("beforeend",r),this.setupMultiplayerCompletionHandlers(e),setTimeout(function(){bt()},200)}},{key:"getCompletionInfo",value:function(e){var t,n,r,o=e.winner===this.game.playerId;switch(e.type||("disconnection"===e.winner?"disconnection":"timeout"===e.winner?"timeout":"normal")){case"disconnection":t="Game Ended",n=e.reason||"Player disconnected",r="#95a5a6";break;case"timeout":t="Time Up!",n="Game timed out (8 minutes)",r="#e67e22";break;default:t=o?"Victory!":"Defeat",n=o?"You Win!":"You Lose!",r=o?"#2ecc71":"#e74c3c"}return{title:t,message:n,titleColor:r,isWinner:o}}},{key:"createCompletionModalHTML",value:function(e,t){var n,r,o=t.player1||(null===(n=this.game.clientGameState)||void 0===n?void 0:n.player1)||{username:"Player 1",score:0,character:"boba"},a=t.player2||(null===(r=this.game.clientGameState)||void 0===r?void 0:r.player2)||{username:"Player 2",score:0,character:"boba"},i=this.getCurrentPlayerCharacter();return'\n      <div id="'.concat(pt.w.ELEMENT_IDS.COMPLETION_MODAL,'" style="').concat(this.getModalStyle(),'">\n        <div style="').concat(this.getContentStyle(),'">\n          <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1.5rem;">\n            ').concat(this.createAvatarHTML(i),'\n            <h2 style="color: ').concat(e.titleColor,'; margin: 0; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);">').concat(e.title,'</h2>\n          </div>\n          \n          <div style="margin: 1.5rem 0;">\n            <p style="margin: 0.8rem 0; font-size: 18px; color: ').concat(e.titleColor,';">\n              <strong>').concat(e.message,'</strong>\n            </p>\n            \n            <div style="margin: 1.5rem 0; padding: 1rem; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">\n              <h3 style="color: #ecf0f1; margin: 0 0 1rem 0; text-align: center;">Final Scores</h3>\n              <div style="display: flex; justify-content: space-between; align-items: center; gap: 2rem;">\n                <div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">\n                  ').concat(this.createAvatarHTML(o.character||"boba"),'\n                  <span style="color: #ecf0f1; font-weight: bold;">').concat(o.username,'</span>\n                  <span style="color: #2ecc71; font-size: 18px; font-weight: bold;">').concat(o.score||0,'</span>\n                </div>\n                \n                <div style="color: #95a5a6; font-size: 24px; font-weight: bold;">VS</div>\n                \n                <div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">\n                  ').concat(this.createAvatarHTML(a.character||"boba"),'\n                  <span style="color: #ecf0f1; font-weight: bold;">').concat(a.username,'</span>\n                  <span style="color: #2ecc71; font-size: 18px; font-weight: bold;">').concat(a.score||0,'</span>\n                </div>\n              </div>\n            </div>\n          </div>\n          \n          <div style="').concat(this.getButtonContainerStyle(),'">\n            ').concat(this.createButton(pt.w.ELEMENT_IDS.VIEW_LEADERBOARD,pt.w.BUTTONS.LEADERBOARD,pt.w.GRADIENTS.LEADERBOARD),"\n            ").concat(this.createButton(pt.w.ELEMENT_IDS.BACK_TO_MENU,pt.w.BUTTONS.BACK_MENU,pt.w.GRADIENTS.BACK_MENU),"\n          </div>\n        </div>\n      </div>\n    ")}},{key:"getCurrentPlayerCharacter",value:function(){if(this.game.clientGameState){var e,t=this.game.playerId===(null===(e=this.game.clientGameState.player1)||void 0===e?void 0:e.id)?this.game.clientGameState.player1:this.game.clientGameState.player2;if(null!=t&&t.character)return t.character}try{var n=localStorage.getItem("boba_vim_selected_character");if(n&&["boba","pinky","golden","black","boba_diamond"].includes(n))return n}catch(e){logger.warn("Failed to load character from localStorage:",e)}return"boba"}},{key:"setupMultiplayerCompletionHandlers",value:function(e){var t=this,n=function(){logger.debug("Setting up multiplayer completion handlers...");var n=document.getElementById(pt.w.ELEMENT_IDS.VIEW_LEADERBOARD);logger.debug("Leaderboard button found:",n),n?(n.removeEventListener("click",t.leaderboardClickHandler),t.leaderboardClickHandler=function(n){return logger.debug("Leaderboard button clicked - data:",e),t.showMultiplayerLeaderboard(),!1},n.addEventListener("click",t.leaderboardClickHandler,{passive:!1}),logger.debug("Leaderboard button handlers set up")):logger.warn("Leaderboard button not found!");var r=document.getElementById(pt.w.ELEMENT_IDS.BACK_TO_MENU);logger.debug("Back to menu button found:",r),r?(r.removeEventListener("click",t.backToMenuClickHandler),t.backToMenuClickHandler=function(t){return logger.debug("Back to menu button clicked - data:",e),logger.debug("Redirecting to:",pt.w.NAVIGATION.MENU_URL),window.location.href=pt.w.NAVIGATION.MENU_URL,!1},r.addEventListener("click",t.backToMenuClickHandler,{passive:!1}),logger.debug("Back to menu button handlers set up")):logger.warn("Back to menu button not found!"),t.setupHoverEffects([{id:pt.w.ELEMENT_IDS.VIEW_LEADERBOARD,text:pt.w.BUTTONS.LEADERBOARD},{id:pt.w.ELEMENT_IDS.BACK_TO_MENU,text:pt.w.BUTTONS.BACK_MENU}])};requestAnimationFrame(n),setTimeout(n,100),setTimeout(n,300)}},{key:"showMultiplayerLeaderboard",value:(r=Gt().m(function e(){var t,n;return Gt().w(function(e){for(;;)switch(e.n){case 0:return logger.debug("showMultiplayerLeaderboard called"),wt(),(t=document.getElementById("completionModal"))&&(t.style.display="none"),n=new gt.H,e.n=1,n.show({currentMapInfo:{id:1,name:"Welcome to Boba"},availableMaps:[],showMapNavigation:!0,multiplayerMode:!0,showModeToggle:!1,onClose:function(){var e=document.getElementById("completionModal");e&&(e.style.display="flex",setTimeout(function(){bt()},100))}});case 1:return e.a(2)}},e)}),o=function(){var e=this,t=arguments;return new Promise(function(n,o){var a=r.apply(e,t);function i(e){It(a,n,o,i,l,"next",e)}function l(e){It(a,n,o,i,l,"throw",e)}i(void 0)})},function(){return o.apply(this,arguments)})},{key:"getModalStyle",value:function(){return"\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: ".concat(pt.w.COLORS.OVERLAY,";\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      z-index: ").concat(pt.w.MODAL.Z_INDEX,";\n    ")}},{key:"getContentStyle",value:function(){return"\n      background: ".concat(pt.w.COLORS.MODAL_BG,";\n      color: white;\n      padding: 2rem;\n      border-radius: 10px;\n      text-align: center;\n      max-width: 600px;\n      width: 95%;\n      max-height: 85vh;\n      overflow: hidden;\n      box-shadow: ").concat(pt.w.SHADOWS.MODAL,";\n      margin-top: 8vh;\n    ")}},{key:"getButtonContainerStyle",value:function(){return"\n      margin: 2rem 0;\n      display: flex;\n      flex-direction: column;\n      gap: 1.5rem;\n      align-items: center;\n    "}},{key:"createButton",value:function(e,t,n){var r=this.getButtonClass(e);return'<button id="'.concat(e,'" class="eightbit-completion-btn ').concat(r,'">').concat(t,"</button>")}},{key:"getButtonClass",value:function(e){return"viewLeaderboard"===e?"leaderboard":"backToMenu"===e?"menu":"nextMap"===e||"previousMap"===e?"navigation":""}},{key:"createAvatarHTML",value:function(e){var t=this.getAvatarSpritePath(e);return'\n      <img \n        src="'.concat(t,'" \n        alt="').concat(e,' avatar" \n        style="\n          width: 48px; \n          height: 48px; \n          border-radius: 8px;\n          border: 3px solid #654321;\n          box-shadow: \n            inset 2px 2px 4px rgba(255, 255, 255, 0.15),\n            inset -2px -2px 4px rgba(0, 0, 0, 0.4),\n            0 4px 8px rgba(0, 0, 0, 0.3);\n          background: linear-gradient(145deg, #8b4513, #a0522d, #d2691e);\n          padding: 2px;\n        "\n      />\n    ')}},{key:"getAvatarSpritePath",value:function(e){switch(e){case"pinky":return"/static/sprites/avatar/pinky_boba_avatar.png";case"golden":return"/static/sprites/avatar/golden_boba_avatar.png";case"black":return"/static/sprites/avatar/black_boba_avatar.png";case"boba_diamond":return"/static/sprites/avatar/diamond_boba_avatar.png";default:return"/static/sprites/avatar/boba_avatar.png"}}},{key:"setupHoverEffects",value:function(e){for(var t=function(){var t=e[n],r=document.getElementById(t.id);if(!r)return 1;var o=t.text;r.addEventListener("mouseenter",function(e){"mouseenter"===e.type&&(r.textContent=pt.w.BUTTONS.HOVER_ICON,r.style.transform="translateY(-3px) scale(1.05)")},{passive:!0}),r.addEventListener("mouseleave",function(e){"mouseleave"===e.type&&(r.textContent=o,r.style.transform="translateY(0) scale(1)")},{passive:!0})},n=0;n<e.length;n++)t()}},{key:"showCompletionModal",value:function(e){this.showUnifiedCompletionModal(e)}},{key:"showGameCompletionMessage",value:function(e){this.showUnifiedCompletionModal(e)}}],t&&Nt(e.prototype,t),n&&Nt(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,r,o}(),_t=12,Rt=["small","medium","large"],Dt=["cloud1.png","cloud2.png","cloud3.png","cloud4.png","cloud5.png","cloud6.png","cloud7.png","cloud8.png","cloud9.png"],xt={TOP_RANGE:80,TOP_OFFSET:5},Lt={MIN:.4,MAX:.4},Bt={MIN_DURATION:35,MAX_DURATION:40},Ht={SPRITE_DIRECTORY:"/static/sprites/clouds/"},Ft={INIT_DELAY:100},Ut="clouds-container",zt="cloud";function Wt(e){return Wt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Wt(e)}function qt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,Vt(r.key),r)}}function Vt(e){var t=function(e,t){if("object"!=Wt(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=Wt(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==Wt(t)?t:t+""}var Yt=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.cloudImages=Dt,this.cloudSizes=Rt,this.cloudsContainer=null,this.cloudCount=_t},(t=[{key:"init",value:function(){this.createCloudsContainer(),this.generateClouds(),logger.debug("ðŸŒ¤ï¸ Cloud system initialized with",this.cloudCount,"clouds")}},{key:"createCloudsContainer",value:function(){var e=document.querySelector(".".concat(Ut));e&&e.remove(),this.cloudsContainer=document.createElement("div"),this.cloudsContainer.className=Ut,document.body.insertBefore(this.cloudsContainer,document.body.firstChild)}},{key:"generateClouds",value:function(){for(var e=1;e<=this.cloudCount;e++){var t=this.createCloudElement(e);this.cloudsContainer.appendChild(t)}}},{key:"createCloudElement",value:function(e){var t=document.createElement("img"),n=this.cloudImages[Math.floor(Math.random()*this.cloudImages.length)];t.src="".concat(Ht.SPRITE_DIRECTORY).concat(n),t.alt="Cloud ".concat(e);var r=this.cloudSizes[Math.floor(Math.random()*this.cloudSizes.length)];t.className="".concat(zt," ").concat(zt,"-").concat(r," ").concat(zt,"-").concat(e);var o=Math.random()*xt.TOP_RANGE+xt.TOP_OFFSET;t.style.top="".concat(o,"%");var a=Lt.MIN+Math.random()*Lt.MAX;t.style.opacity=a;var i=Bt.MIN_DURATION+Math.random()*Bt.MAX_DURATION;t.style.animationDuration="".concat(i,"s");var l=-Math.random()*i;return t.style.animationDelay="".concat(l,"s"),t.onerror=function(){logger.warn("Cloud image not found: ".concat(n)),t.style.display="none"},t}},{key:"removeClouds",value:function(){this.cloudsContainer&&this.cloudsContainer.remove()}}])&&qt(e.prototype,t),n&&qt(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}();function Jt(e){return Jt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Jt(e)}function Kt(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function a(n,r,o,a){var c=r&&r.prototype instanceof l?r:l,u=Object.create(c.prototype);return $t(u,"_invoke",function(n,r,o){var a,l,c,u=0,s=o||[],d=!1,m={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,n){return a=t,l=0,c=e,m.n=n,i}};function p(n,r){for(l=n,c=r,t=0;!d&&u&&!o&&t<s.length;t++){var o,a=s[t],p=m.p,g=a[2];n>3?(o=g===r)&&(c=a[(l=a[4])?5:(l=3,3)],a[4]=a[5]=e):a[0]<=p&&((o=n<2&&p<a[1])?(l=0,m.v=r,m.n=a[1]):p<g&&(o=n<3||a[0]>r||r>g)&&(a[4]=n,a[5]=r,m.n=g,l=0))}if(o||n>1)return i;throw d=!0,r}return function(o,s,g){if(u>1)throw TypeError("Generator is already running");for(d&&1===s&&p(s,g),l=s,c=g;(t=l<2?e:c)||!d;){a||(l?l<3?(l>1&&(m.n=-1),p(l,c)):m.n=c:m.v=c);try{if(u=2,a){if(l||(o="next"),t=a[o]){if(!(t=t.call(a,c)))throw TypeError("iterator result is not an object");if(!t.done)return t;c=t.value,l<2&&(l=0)}else 1===l&&(t=a.return)&&t.call(a),l<2&&(c=TypeError("The iterator does not provide a '"+o+"' method"),l=1);a=e}else if((t=(d=m.n<0)?c:n.call(r,m))!==i)break}catch(t){a=e,l=1,c=t}finally{u=1}}return{value:t,done:d}}}(n,o,a),!0),u}var i={};function l(){}function c(){}function u(){}t=Object.getPrototypeOf;var s=[][r]?t(t([][r]())):($t(t={},r,function(){return this}),t),d=u.prototype=l.prototype=Object.create(s);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,$t(e,o,"GeneratorFunction")),e.prototype=Object.create(d),e}return c.prototype=u,$t(d,"constructor",u),$t(u,"constructor",c),c.displayName="GeneratorFunction",$t(u,o,"GeneratorFunction"),$t(d),$t(d,o,"Generator"),$t(d,r,function(){return this}),$t(d,"toString",function(){return"[object Generator]"}),(Kt=function(){return{w:a,m}})()}function $t(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}$t=function(e,t,n,r){function a(t,n){$t(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},$t(e,t,n,r)}function Xt(e,t,n,r,o,a,i){try{var l=e[a](i),c=l.value}catch(e){return void n(e)}l.done?t(c):Promise.resolve(c).then(r,o)}function Qt(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var a=e.apply(t,n);function i(e){Xt(a,r,o,i,l,"next",e)}function l(e){Xt(a,r,o,i,l,"throw",e)}i(void 0)})}}function Zt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,en(r.key),r)}}function en(e){var t=function(e,t){if("object"!=Jt(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=Jt(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==Jt(t)?t:t+""}document.addEventListener("DOMContentLoaded",function(){setTimeout(function(){window.cloudManager=new Yt,window.cloudManager.init()},Ft.INIT_DELAY)}),window.CloudManager=Yt;var tn=new(function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.audio=null,this.musicButton=null,this.stopOverlay=null,this.isPlaying=!1,this.storageKey="boba-vim-music-enabled",this.init()},t=[{key:"init",value:function(){var e=this;"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){return e.setupMusic()}):this.setupMusic()}},{key:"setupMusic",value:function(){var e=this;logger.debug("Setting up game music..."),this.audio=document.getElementById("gameBackgroundMusic"),this.musicButton=document.getElementById("gameMusicButton"),this.stopOverlay=document.getElementById("gameStopOverlay"),logger.debug("Game music elements found:",{audio:!!this.audio,musicButton:!!this.musicButton,stopOverlay:!!this.stopOverlay}),this.audio&&this.musicButton?(this.musicButton.addEventListener("click",function(){return e.toggleMusic()}),this.audio.addEventListener("loadstart",function(){return logger.debug("Game audio loading started")}),this.audio.addEventListener("canplay",function(){return logger.debug("Game audio can play")}),this.audio.addEventListener("play",function(){return logger.debug("Game audio started playing")}),this.audio.addEventListener("pause",function(){return logger.debug("Game audio paused")}),this.audio.addEventListener("error",function(e){return logger.error("Game audio error:",e)}),this.initializeMusic()):logger.warn("Game music elements not found - music functionality disabled")}},{key:"getMusicPreference",value:function(){var e=localStorage.getItem(this.storageKey);return null===e||"true"===e}},{key:"saveMusicPreference",value:function(e){localStorage.setItem(this.storageKey,e.toString())}},{key:"initializeMusic",value:(i=Qt(Kt().m(function e(){var t;return Kt().w(function(e){for(;;)switch(e.n){case 0:if(t=this.getMusicPreference(),logger.debug("Game music preference from localStorage:",t),this.isPlaying=!1,this.updateButtonState(),!t){e.n=2;break}return e.n=1,this.startMusic();case 1:e.n=3;break;case 2:logger.debug("Game music disabled by user preference");case 3:return e.a(2)}},e,this)})),function(){return i.apply(this,arguments)})},{key:"startMusic",value:(a=Qt(Kt().m(function e(){var t,n;return Kt().w(function(e){for(;;)switch(e.p=e.n){case 0:if(this.audio){e.n=1;break}return logger.error("No game audio element available"),e.a(2);case 1:if(e.p=1,logger.debug("Attempting to start game music..."),this.audio.volume=.8,void 0===(t=this.audio.play())){e.n=3;break}return e.n=2,t;case 2:this.isPlaying=!0,logger.debug("Game music started successfully");case 3:this.updateButtonState(),e.n=5;break;case 4:e.p=4,n=e.v,logger.debug("Game music autoplay prevented by browser policy. User interaction required.",n),this.isPlaying=!1,this.updateButtonState(),this.addAutoplayFallback();case 5:return e.a(2)}},e,this,[[1,4]])})),function(){return a.apply(this,arguments)})},{key:"addAutoplayFallback",value:function(){var e=this;logger.debug("Adding game music autoplay fallback - music will start on next user interaction");var t=function(){var n=Qt(Kt().m(function n(){var r;return Kt().w(function(n){for(;;)switch(n.p=n.n){case 0:if(e.isPlaying||!e.getMusicPreference()){n.n=4;break}return n.p=1,logger.debug("Attempting to start game music after user interaction..."),n.n=2,e.audio.play();case 2:e.isPlaying=!0,e.updateButtonState(),logger.debug("Game music started successfully after user interaction"),n.n=4;break;case 3:n.p=3,r=n.v,logger.error("Failed to start game music even after user interaction:",r);case 4:document.removeEventListener("click",t),document.removeEventListener("keydown",t),document.removeEventListener("touchstart",t);case 5:return n.a(2)}},n,null,[[1,3]])}));return function(){return n.apply(this,arguments)}}();document.addEventListener("click",t,{once:!0}),document.addEventListener("keydown",t,{once:!0}),document.addEventListener("touchstart",t,{once:!0})}},{key:"toggleMusic",value:(o=Qt(Kt().m(function e(){var t;return Kt().w(function(e){for(;;)switch(e.p=e.n){case 0:if(this.audio){e.n=1;break}return logger.error("No game audio element for toggle"),e.a(2);case 1:if(logger.debug("Toggling game music. Current state:",this.isPlaying),e.p=2,!this.isPlaying){e.n=3;break}this.audio.pause(),this.isPlaying=!1,logger.debug("Game music paused"),e.n=5;break;case 3:return logger.debug("Attempting to start game music from button click..."),this.audio.currentTime=0,this.audio.volume=.8,e.n=4,this.audio.play();case 4:this.isPlaying=!0,logger.debug("Game music started from button click");case 5:this.saveMusicPreference(this.isPlaying),this.updateButtonState(),e.n=7;break;case 6:e.p=6,t=e.v,logger.error("Error toggling game music:",t),this.updateButtonState();case 7:return e.a(2)}},e,this,[[2,6]])})),function(){return o.apply(this,arguments)})},{key:"updateButtonState",value:function(){if(this.musicButton){logger.debug("Updating game music button state. Playing:",this.isPlaying);var e=this.musicButton.closest(".game-music-button");this.isPlaying?(e&&e.classList.remove("stopped"),this.musicButton.classList.remove("stopped"),this.musicButton.title="Stop Music",logger.debug("Game music button set to playing state (normal color)")):(e&&e.classList.add("stopped"),this.musicButton.classList.add("stopped"),this.musicButton.title="Play Music",logger.debug("Game music button set to stopped state (should be grey with pause icon)")),e&&e.offsetHeight}else logger.error("No game music button element for state update")}},{key:"stopMusic",value:function(){this.audio&&this.isPlaying&&(this.audio.pause(),this.isPlaying=!1,this.saveMusicPreference(!1),this.updateButtonState())}},{key:"playMusic",value:(r=Qt(Kt().m(function e(){var t;return Kt().w(function(e){for(;;)switch(e.p=e.n){case 0:if(!this.audio||this.isPlaying){e.n=4;break}return e.p=1,e.n=2,this.audio.play();case 2:this.isPlaying=!0,this.saveMusicPreference(!0),this.updateButtonState(),e.n=4;break;case 3:e.p=3,t=e.v,logger.error("Error starting game music:",t);case 4:return e.a(2)}},e,this,[[1,3]])})),function(){return r.apply(this,arguments)})}],t&&Zt(e.prototype,t),n&&Zt(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,r,o,a,i}());function nn(){return tn}function rn(e){return rn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},rn(e)}function on(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function a(n,r,o,a){var c=r&&r.prototype instanceof l?r:l,u=Object.create(c.prototype);return an(u,"_invoke",function(n,r,o){var a,l,c,u=0,s=o||[],d=!1,m={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,n){return a=t,l=0,c=e,m.n=n,i}};function p(n,r){for(l=n,c=r,t=0;!d&&u&&!o&&t<s.length;t++){var o,a=s[t],p=m.p,g=a[2];n>3?(o=g===r)&&(c=a[(l=a[4])?5:(l=3,3)],a[4]=a[5]=e):a[0]<=p&&((o=n<2&&p<a[1])?(l=0,m.v=r,m.n=a[1]):p<g&&(o=n<3||a[0]>r||r>g)&&(a[4]=n,a[5]=r,m.n=g,l=0))}if(o||n>1)return i;throw d=!0,r}return function(o,s,g){if(u>1)throw TypeError("Generator is already running");for(d&&1===s&&p(s,g),l=s,c=g;(t=l<2?e:c)||!d;){a||(l?l<3?(l>1&&(m.n=-1),p(l,c)):m.n=c:m.v=c);try{if(u=2,a){if(l||(o="next"),t=a[o]){if(!(t=t.call(a,c)))throw TypeError("iterator result is not an object");if(!t.done)return t;c=t.value,l<2&&(l=0)}else 1===l&&(t=a.return)&&t.call(a),l<2&&(c=TypeError("The iterator does not provide a '"+o+"' method"),l=1);a=e}else if((t=(d=m.n<0)?c:n.call(r,m))!==i)break}catch(t){a=e,l=1,c=t}finally{u=1}}return{value:t,done:d}}}(n,o,a),!0),u}var i={};function l(){}function c(){}function u(){}t=Object.getPrototypeOf;var s=[][r]?t(t([][r]())):(an(t={},r,function(){return this}),t),d=u.prototype=l.prototype=Object.create(s);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,an(e,o,"GeneratorFunction")),e.prototype=Object.create(d),e}return c.prototype=u,an(d,"constructor",u),an(u,"constructor",c),c.displayName="GeneratorFunction",an(u,o,"GeneratorFunction"),an(d),an(d,o,"Generator"),an(d,r,function(){return this}),an(d,"toString",function(){return"[object Generator]"}),(on=function(){return{w:a,m}})()}function an(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}an=function(e,t,n,r){function a(t,n){an(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},an(e,t,n,r)}function ln(e,t,n,r,o,a,i){try{var l=e[a](i),c=l.value}catch(e){return void n(e)}l.done?t(c):Promise.resolve(c).then(r,o)}function cn(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var a=e.apply(t,n);function i(e){ln(a,r,o,i,l,"next",e)}function l(e){ln(a,r,o,i,l,"throw",e)}i(void 0)})}}function un(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,sn(r.key),r)}}function sn(e){var t=function(e,t){if("object"!=rn(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=rn(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==rn(t)?t:t+""}var dn=function(){return e=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t},t=[{key:"initializeGameModules",value:function(){var e=this;(new Yt).init();var t=nn();setTimeout(function(){if(t&&t.audio){t.audio.volume=.9,logger.debug("Multiplayer music volume set to 0.9");var e=t.toggleMusic.bind(t);t.toggleMusic=cn(on().m(function t(){return on().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,e();case 1:this.audio&&this.isPlaying&&(this.audio.volume=.9);case 2:return t.a(2)}},t,this)}))}},100),this.applyCharacterGameBoardStyling(),setTimeout(function(){logger.debug("Initializing game modules for multiplayer..."),e.initializeModule("lineNumbersModule","initializeLineNumbers"),e.initializeModule("relativeLineNumbersModule","initializeRelativeLineNumbers"),e.initializeModule("spaceHighlightModule","initializeSpaceHighlight"),e.initializeModule("tutorialHintsModule","initializeTutorialHints"),void 0!==window.scoreAnimationsModule?window.scoreAnimationsModule.initializeScoreAnimations():logger.warn("scoreAnimationsModule not found"),e.initializeModule("paragraphModule","initializeParagraphSeparation"),e.initializeModule("fullscreenModule","initializeFullscreen"),e.initializeModule("responsiveScaling","initializeResponsiveScaling"),void 0!==window.userPreferencesModule?window.userPreferencesModule.applySavedPreferences():logger.warn("userPreferencesModule not found")},200)}},{key:"initializeModule",value:function(e,t){void 0!==window[e]&&"function"==typeof window[e][t]?window[e][t]():logger.warn("".concat(e," not found or ").concat(t," is not a function"))}},{key:"applyCharacterGameBoardStyling",value:function(){var e=document.querySelector(".game-board");if(e){var t=localStorage.getItem("boba_vim_selected_character")||"boba";["game-board-boba","game-board-pinky","game-board-golden","game-board-black","game-board-boba_diamond"].forEach(function(t){return e.classList.remove(t)}),e.classList.add("game-board-".concat(t)),logger.debug("Applied multiplayer game board styling for character: ".concat(t))}}},{key:"disableSoloGameHandlers",value:function(){window.IS_MULTIPLAYER_ACTIVE=!0,window.gameState&&(window.gameState.isActive=!1),this.game.gameStateManager.initializeClientGameState()}}],t&&un(e.prototype,t),n&&un(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n}();function mn(e){return mn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},mn(e)}function pn(){var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function a(n,r,o,a){var c=r&&r.prototype instanceof l?r:l,u=Object.create(c.prototype);return gn(u,"_invoke",function(n,r,o){var a,l,c,u=0,s=o||[],d=!1,m={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,n){return a=t,l=0,c=e,m.n=n,i}};function p(n,r){for(l=n,c=r,t=0;!d&&u&&!o&&t<s.length;t++){var o,a=s[t],p=m.p,g=a[2];n>3?(o=g===r)&&(c=a[(l=a[4])?5:(l=3,3)],a[4]=a[5]=e):a[0]<=p&&((o=n<2&&p<a[1])?(l=0,m.v=r,m.n=a[1]):p<g&&(o=n<3||a[0]>r||r>g)&&(a[4]=n,a[5]=r,m.n=g,l=0))}if(o||n>1)return i;throw d=!0,r}return function(o,s,g){if(u>1)throw TypeError("Generator is already running");for(d&&1===s&&p(s,g),l=s,c=g;(t=l<2?e:c)||!d;){a||(l?l<3?(l>1&&(m.n=-1),p(l,c)):m.n=c:m.v=c);try{if(u=2,a){if(l||(o="next"),t=a[o]){if(!(t=t.call(a,c)))throw TypeError("iterator result is not an object");if(!t.done)return t;c=t.value,l<2&&(l=0)}else 1===l&&(t=a.return)&&t.call(a),l<2&&(c=TypeError("The iterator does not provide a '"+o+"' method"),l=1);a=e}else if((t=(d=m.n<0)?c:n.call(r,m))!==i)break}catch(t){a=e,l=1,c=t}finally{u=1}}return{value:t,done:d}}}(n,o,a),!0),u}var i={};function l(){}function c(){}function u(){}t=Object.getPrototypeOf;var s=[][r]?t(t([][r]())):(gn(t={},r,function(){return this}),t),d=u.prototype=l.prototype=Object.create(s);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,u):(e.__proto__=u,gn(e,o,"GeneratorFunction")),e.prototype=Object.create(d),e}return c.prototype=u,gn(d,"constructor",u),gn(u,"constructor",c),c.displayName="GeneratorFunction",gn(u,o,"GeneratorFunction"),gn(d),gn(d,o,"Generator"),gn(d,r,function(){return this}),gn(d,"toString",function(){return"[object Generator]"}),(pn=function(){return{w:a,m}})()}function gn(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}gn=function(e,t,n,r){function a(t,n){gn(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(a("next",0),a("throw",1),a("return",2))},gn(e,t,n,r)}function fn(e,t,n,r,o,a,i){try{var l=e[a](i),c=l.value}catch(e){return void n(e)}l.done?t(c):Promise.resolve(c).then(r,o)}function yn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,hn(r.key),r)}}function hn(e){var t=function(e,t){if("object"!=mn(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=mn(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==mn(t)?t:t+""}var vn=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.matchId=window.MULTIPLAYER_MATCH_ID,this.isMultiplayer=window.IS_MULTIPLAYER,this.gameId=null,this.playerId=null,this.gameState=null,this.isConnected=!1,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.websocket=null,this.clientGameState=null,this.preferredColumn=0,this.lastRenderedPositions={player1:null,player2:null,pearl:null},this.lastForceUpdate=0,this.countdownActive=!0,(0,F.G)(),this.gameStateManager=new g(this),this.keyboardHandler=new R(this),this.movementProcessor=new de(this),this.displayManager=new Fe(this),this.websocketManager=new mt(this),this.gameCompletionHandler=new jt(this),this.moduleInitializer=new dn(this),this.moduleInitializer.initializeGameModules(),this.init()},t=[{key:"init",value:function(){logger.debug("Initializing multiplayer game...",{matchId:this.matchId}),this.moduleInitializer.disableSoloGameHandlers(),this.setupEventListeners(),this.keyboardHandler.setupKeyboardControls(),this.showDebugInfo(),this.gameStateManager.loadGameState()}},{key:"setupEventListeners",value:function(){var e,t,n,r=this;null===(e=document.getElementById("quit-multiplayer-btn"))||void 0===e||e.addEventListener("click",function(){r.quitGame()}),null===(t=document.getElementById("retry-connection-btn"))||void 0===t||t.addEventListener("click",function(){r.retryConnection()}),null===(n=document.getElementById("toggle-debug-btn"))||void 0===n||n.addEventListener("click",function(){r.toggleDebug()}),window.addEventListener("beforeunload",function(){r.websocketManager.disconnect()})}},{key:"toggleDebug",value:function(){var e=document.getElementById("multiplayer-debug-info");if(e){var t="none"!==e.style.display;e.style.display=t?"none":"block";var n=document.getElementById("toggle-debug-btn");n&&(n.textContent=t?"Show Debug":"Hide Debug")}}},{key:"showDebugInfo",value:function(){if("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname){var e=document.getElementById("multiplayer-debug-info");e&&(e.style.display="block")}}},{key:"getCurrentPlayerPosition",value:function(){var e;if(!this.clientGameState)return{row:0,col:0};var t=this.playerId===(null===(e=this.clientGameState.player1)||void 0===e?void 0:e.id)?this.clientGameState.player1:this.clientGameState.player2;return(null==t?void 0:t.position)||{row:0,col:0}}},{key:"getCurrentPlayerScore",value:function(){var e;if(!this.clientGameState)return 0;var t=this.playerId===(null===(e=this.clientGameState.player1)||void 0===e?void 0:e.id)?this.clientGameState.player1:this.clientGameState.player2;return(null==t?void 0:t.score)||0}},{key:"updateConnectionStatus",value:function(e,t){var n=document.getElementById("status-dot"),r=document.getElementById("status-text");n&&(n.className="status-dot ".concat(e)),r&&(r.textContent=t),this.isConnected="connected"===e}},{key:"retryConnection",value:function(){this.reconnectAttempts<this.maxReconnectAttempts?(this.reconnectAttempts++,this.gameStateManager.loadGameState()):this.displayManager.showError("Max reconnection attempts reached. Please refresh the page.")}},{key:"quitGame",value:(r=pn().m(function e(){return pn().w(function(e){for(;;)switch(e.n){case 0:if(!confirm("Are you sure you want to quit the game?")){e.n=2;break}return e.n=1,this.websocketManager.disconnect();case 1:window.location.href="/";case 2:return e.a(2)}},e,this)}),o=function(){var e=this,t=arguments;return new Promise(function(n,o){var a=r.apply(e,t);function i(e){fn(a,n,o,i,l,"next",e)}function l(e){fn(a,n,o,i,l,"throw",e)}i(void 0)})},function(){return o.apply(this,arguments)})}],t&&yn(e.prototype,t),n&&yn(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,r,o}();document.addEventListener("DOMContentLoaded",function(){logger.debug("DOM loaded, checking multiplayer initialization:",{isMultiplayer:window.IS_MULTIPLAYER,matchId:window.MULTIPLAYER_MATCH_ID}),window.IS_MULTIPLAYER&&window.MULTIPLAYER_MATCH_ID?(logger.debug("Initializing multiplayer game..."),new vn):logger.error("Multiplayer initialization failed - missing variables:",{isMultiplayer:window.IS_MULTIPLAYER,matchId:window.MULTIPLAYER_MATCH_ID})})},812:(e,t,n)=>{function r(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a,i,l=[],c=!0,u=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=a.call(n)).done)&&(l.push(r.value),l.length!==t);c=!0);}catch(e){u=!0,o=e}finally{try{if(!c&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(u)throw o}}return l}}(e,t)||function(e,t){if(e){if("string"==typeof e)return o(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?o(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}n.d(t,{Cs:()=>i});var a={h:{direction:"h",description:"LEFT â†"},j:{direction:"j",description:"DOWN â†“"},k:{direction:"k",description:"UP â†‘"},l:{direction:"l",description:"RIGHT â†’"},ArrowLeft:{direction:"ArrowLeft",description:"NOOB: LEFT â†"},ArrowDown:{direction:"ArrowDown",description:"NOOB: DOWN â†“"},ArrowUp:{direction:"ArrowUp",description:"NOOB: UP â†‘"},ArrowRight:{direction:"ArrowRight",description:"NOOB: RIGHT â†’"},w:{direction:"w",description:"WORD FORWARD â†’"},W:{direction:"W",description:"WORD FORWARD (space-separated) â†’"},b:{direction:"b",description:"WORD BACK â†"},B:{direction:"B",description:"WORD BACK (space-separated) â†"},e:{direction:"e",description:"END WORD â†’"},E:{direction:"E",description:"END WORD (space-separated) â†’"},ge:{direction:"ge",description:"END PREV WORD â†"},gE:{direction:"gE",description:"END PREV WORD (non-blank sequence) â†"},0:{direction:"0",description:"LINE START â†"},$:{direction:"$",description:"LINE END â†’"},"^":{direction:"^",description:"FIRST NON-BLANK CHAR â†"},g_:{direction:"g_",description:"LAST NON-BLANK CHAR â†’"},H:{direction:"H",description:"TOP OF SCREEN"},M:{direction:"M",description:"MIDDLE OF SCREEN"},L:{direction:"L",description:"BOTTOM OF SCREEN"},"{":{direction:"{",description:"PREV PARAGRAPH â†"},"}":{direction:"}",description:"NEXT PARAGRAPH â†’"},"(":{direction:"(",description:"PREV SENTENCE â†"},")":{direction:")",description:"NEXT SENTENCE â†’"},g:{direction:"g",description:"g combination pressed"},gg:{direction:"gg",description:"TOP OF FILE"},G:{direction:"G",description:"END OF FILE"},f:{direction:"f<char>",description:"FIND CHAR â†’"},F:{direction:"F<char>",description:"FIND CHAR â†"},t:{direction:"t<char>",description:"TILL CHAR â†’"},T:{direction:"T<char>",description:"TILL CHAR â†"},";":{direction:";",description:"REPEAT SEARCH"},",":{direction:",",description:"REVERSE REPEAT SEARCH"},"%":{direction:"%",description:"MATCHING BRACKET"}},i=(Object.fromEntries(Object.entries(a).map(function(e){var t=r(e,2),n=t[0],o=t[1];return[n,"You pressed ".concat(n," to go ").concat(o.description)]})),Object.fromEntries(Object.entries(a).map(function(e){var t=r(e,2),n=t[0],o=t[1];return[n,"You pressed ".concat(n," to go ").concat(o.description," - BLOCKED!")]})),Object.keys(a))}},o={};function a(e){var t=o[e];if(void 0!==t)return t.exports;var n=o[e]={exports:{}};return r[e](n,n.exports,a),n.exports}a.m=r,e=[],a.O=(t,n,r,o)=>{if(!n){var i=1/0;for(s=0;s<e.length;s++){for(var[n,r,o]=e[s],l=!0,c=0;c<n.length;c++)(!1&o||i>=o)&&Object.keys(a.O).every(e=>a.O[e](n[c]))?n.splice(c--,1):(l=!1,o<i&&(i=o));if(l){e.splice(s--,1);var u=r();void 0!==u&&(t=u)}}return t}o=o||0;for(var s=e.length;s>0&&e[s-1][2]>o;s--)e[s]=e[s-1];e[s]=[n,r,o]},a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.f={},a.e=e=>Promise.all(Object.keys(a.f).reduce((t,n)=>(a.f[n](e,t),t),[])),a.u=e=>e+".bundle.js",a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),t={},n="boba-vim:",a.l=(e,r,o,i)=>{if(t[e])t[e].push(r);else{var l,c;if(void 0!==o)for(var u=document.getElementsByTagName("script"),s=0;s<u.length;s++){var d=u[s];if(d.getAttribute("src")==e||d.getAttribute("data-webpack")==n+o){l=d;break}}l||(c=!0,(l=document.createElement("script")).charset="utf-8",l.timeout=120,a.nc&&l.setAttribute("nonce",a.nc),l.setAttribute("data-webpack",n+o),l.src=e),t[e]=[r];var m=(n,r)=>{l.onerror=l.onload=null,clearTimeout(p);var o=t[e];if(delete t[e],l.parentNode&&l.parentNode.removeChild(l),o&&o.forEach(e=>e(r)),n)return n(r)},p=setTimeout(m.bind(null,void 0,{type:"timeout",target:l}),12e4);l.onerror=m.bind(null,l.onerror),l.onload=m.bind(null,l.onload),c&&document.head.appendChild(l)}},a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.j=217,(()=>{var e;a.g.importScripts&&(e=a.g.location+"");var t=a.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");if(n.length)for(var r=n.length-1;r>-1&&(!e||!/^http(s?):/.test(e));)e=n[r--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),a.p=e})(),(()=>{var e={217:0};a.f.j=(t,n)=>{var r=a.o(e,t)?e[t]:void 0;if(0!==r)if(r)n.push(r[2]);else{var o=new Promise((n,o)=>r=e[t]=[n,o]);n.push(r[2]=o);var i=a.p+a.u(t),l=new Error;a.l(i,n=>{if(a.o(e,t)&&(0!==(r=e[t])&&(e[t]=void 0),r)){var o=n&&("load"===n.type?"missing":n.type),i=n&&n.target&&n.target.src;l.message="Loading chunk "+t+" failed.\n("+o+": "+i+")",l.name="ChunkLoadError",l.type=o,l.request=i,r[1](l)}},"chunk-"+t,t)}},a.O.j=t=>0===e[t];var t=(t,n)=>{var r,o,[i,l,c]=n,u=0;if(i.some(t=>0!==e[t])){for(r in l)a.o(l,r)&&(a.m[r]=l[r]);if(c)var s=c(a)}for(t&&t(n);u<i.length;u++)o=i[u],a.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return a.O(s)},n=self.webpackChunkboba_vim=self.webpackChunkboba_vim||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var i=a.O(void 0,[76],()=>a(699));i=a.O(i)})();